import{a as pt}from"./chunk-UVRBIC3A.js";import{c as ct,d as ze}from"./chunk-K7FIKSFS.js";import{a as Be,b as ve,d as K,e as pe,f as J,g as Se,h as _t,i as be,l as Re,m as Ie,n as ut,o as dt,p as ft,q as we,r as Ct,s as xe}from"./chunk-5HCTQAZX.js";import{a as W,b as V,c as H,d as ge,e as D,f as j,g as Te,h as le,i as ce,j as Y,l as z,m as F,n as mt,o as y}from"./chunk-B6E2SLWS.js";import{c as k}from"./chunk-7BDXVLIU.js";import{Ab as _,B as ue,Bb as l,E as de,Fb as Z,Gb as Ce,Ha as c,Hb as ot,Ib as I,Jb as U,Ka as B,Kb as se,Mb as rt,Na as Ue,Nb as at,Oa as fe,Ob as st,Pa as X,Q as Ke,Sa as d,T as Je,Tb as O,Ub as lt,Vb as he,W as et,Ya as g,Yb as Ee,aa as C,eb as u,fc as w,gb as tt,hb as b,hc as P,ib as m,ja as h,jb as ae,ka as E,kb as it,l as _e,la as S,lb as L,mb as $,nb as a,ob as r,p as Ge,pb as p,qb as nt,rb as T,ua as A,va as f,wb as v,x as Ye,xb as Q,yb as G,zb as ke}from"./chunk-LRQIUYMT.js";import"./chunk-2NFLSA4Y.js";var ee=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-swap"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M320-440v-287L217-624l-57-56 200-200 200 200-57 56-103-103v287h-80ZM600-80 400-280l57-56 103 103v-287h80v287l103-103 57 56L600-80Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var te=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-clear"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","m456-320 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56Zm-96 160q-19 0-36-8.5T296-192L80-480l216-288q11-15 28-23.5t36-8.5h440q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H360ZM180-480l180 240h440v-480H360L180-480Zm400 0Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var Ne=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-cut"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M760-120 480-400l-94 94q8 15 11 32t3 34q0 66-47 113T240-80q-66 0-113-47T80-240q0-66 47-113t113-47q17 0 34 3t32 11l94-94-94-94q-15 8-32 11t-34 3q-66 0-113-47T80-720q0-66 47-113t113-47q66 0 113 47t47 113q0 17-3 34t-11 32l494 494v40H760ZM600-520l-80-80 240-240h120v40L600-520ZM240-640q33 0 56.5-23.5T320-720q0-33-23.5-56.5T240-800q-33 0-56.5 23.5T160-720q0 33 23.5 56.5T240-640Zm240 180q8 0 14-6t6-14q0-8-6-14t-14-6q-8 0-14 6t-6 14q0 8 6 14t14 6ZM240-160q33 0 56.5-23.5T320-240q0-33-23.5-56.5T240-320q-33 0-56.5 23.5T160-240q0 33 23.5 56.5T240-160Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var ie=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-delete"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var Oe=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-down"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M440-800v487L216-537l-56 57 320 320 320-320-56-57-224 224v-487h-80Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var ye=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-paste"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h167q11-35 43-57.5t70-22.5q40 0 71.5 22.5T594-840h166q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560h-80v120H280v-120h-80v560Zm280-560q17 0 28.5-11.5T520-800q0-17-11.5-28.5T480-840q-17 0-28.5 11.5T440-800q0 17 11.5 28.5T480-760Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var Et=["content"],gt=["keyword"],Tt=["variable"],vt=["select"],St=(n,t,e)=>({"font-bold":n,"text-green-light":t,"text-red-light":e}),bt=n=>({width:n});function Rt(n,t){if(n&1&&(a(0,"span",5),I(1),r()),n&2){let e=t.$implicit;c(),U(e)}}function It(n,t){if(n&1&&(a(0,"span",6),I(1),r()),n&2){let e=t.$implicit,i=l();u("ngClass",he(2,St,i.highlighVariable(),i.highlighVariable()&&i.variableActive(e),i.highlighVariable()&&!i.variableActive(e))),c(),U(e)}}function wt(n,t){if(n&1&&(a(0,"option",8),I(1),r()),n&2){let e=l(2).$implicit,i=l();u("value",i.NOT),c(),se("NOT ",i.variablePlaceholder(e),"")}}function xt(n,t){if(n&1&&(a(0,"option",8),I(1),r()),n&2){let e=l(2).$implicit,i=l();u("value",i.AND),c(),se("",i.variablePlaceholder(e)," AND x")}}function Nt(n,t){if(n&1&&(a(0,"option",8),I(1),r()),n&2){let e=l(2).$implicit,i=l();u("value",i.OR),c(),se("",i.variablePlaceholder(e)," OR x")}}function Ot(n,t){if(n&1&&(a(0,"option",8),I(1,"REMOVE"),r()),n&2){let e=l(3);u("value",e.REMOVE)}}function yt(n,t){if(n&1&&(a(0,"option",9),I(1),r()),n&2){let e=l().$implicit,i=l().$implicit,o=l();u("value",e)("selected",i===e)("disabled",e===o.PLEASE_SELECT),c(),se(" ",e," ")}}function Mt(n,t){if(n&1&&g(0,wt,2,2,"option",8)(1,xt,2,2,"option",8)(2,Nt,2,2,"option",8)(3,Ot,2,1,"option",8)(4,yt,2,4,"option",9),n&2){let e,i=t.$implicit,o=l(2);m((e=i)===o.NOT?0:e===o.AND?1:e===o.OR?2:e===o.REMOVE?3:4)}}function At(n,t){if(n&1){let e=T();a(0,"select",7,4),_("change",function(){let o=h(e),s=o.$implicit,R=o.selection,M=ot(1);return E(R(M.value,s))}),L(2,Mt,5,1,null,null,ae),r()}if(n&2){let e=t.options,i=t.width;tt(O(2,bt,i)),c(2),$(e)}}var Xe="NOT",Ze="AND",We="OR",He="REMOVE",Me=class n{condition=f.required();selectVariables=f.required();content=X.required("content",{read:Ue});keywordTemplate=X.required("keyword",{read:B});variableTemplate=X.required("variable",{read:B});selectTemplate=X.required("select",{read:B});state=C(y);activeAnswers=this.state.signal("activeAnswers");mode=this.state.signal("rulesMode");highlighVariable=w(()=>this.mode()!=="edit"&&this.state.signal("highlightVariableStatus")());serializer=C(F);serializedCondition=w(()=>this.serializer.serialize(this.condition()));PLEASE_SELECT=D.string;ALWAYS=j.string;NOT=Xe;AND=Ze;OR=We;REMOVE=He;conditionChanged=A();constructor(){P(()=>{this.mode(),this.condition(),this.selectVariables(),this.repaint()})}repaint(){this.content().clear(),!(this.mode()!=="edit"&&this.condition()instanceof j)&&(this.paintKeyword("IF"),this.paintCondition(this.condition(),t=>{t?this.conditionChanged.emit(t):this.conditionChanged.emit(new D)}))}calculateOptions(t){return[this.PLEASE_SELECT,this.ALWAYS,...this.selectVariables(),this.NOT,this.AND,this.OR,this.REMOVE].filter(e=>!t.includes(e))}createFromPrevious(t){return t===this.PLEASE_SELECT||t===this.ALWAYS?new D:new ge(t)}selection(t,e){return t===this.NOT?new Te(this.createFromPrevious(e)):t===this.AND?new le(this.createFromPrevious(e),new D):t===this.OR?new ce(this.createFromPrevious(e),new D):t===this.REMOVE?null:t===this.ALWAYS?new j:new ge(t)}paintKeyword(t){this.content().createEmbeddedView(this.keywordTemplate(),{$implicit:t})}paintSelect(t,e,i){this.content().createEmbeddedView(this.selectTemplate(),{$implicit:t,options:this.calculateOptions(i),selection:(o,s)=>{e(this.selection(o,s))},width:(t.length*9+30).toString()+"px"})}paintVariable(t){this.content().createEmbeddedView(this.variableTemplate(),{$implicit:t})}paintCondition(t,e,i=[]){if(t instanceof Te){let o=i.filter(s=>s!==this.ALWAYS);this.paintKeyword("NOT"),this.paintCondition(t.not,s=>{e(s?new Te(s):null)},o)}else if(t instanceof le){let o=[...i,this.ALWAYS];this.paintCondition(t.left,s=>{e(s?new le(s,t.right):t.right)},o),this.paintKeyword("AND"),this.paintCondition(t.right,s=>{e(s?new le(t.left,s):t.left)},o)}else if(t instanceof ce){let o=[...i,this.ALWAYS];this.paintCondition(t.left,s=>{e(s?new ce(s,t.right):t.right)},o),this.paintKeyword("OR"),this.paintCondition(t.right,s=>{e(s?new ce(t.left,s):t.left)},o)}else t instanceof ge&&(this.mode()==="edit"?this.paintSelect(t.variable,e,i):this.paintVariable(t.variable))}variableActive(t){return this.activeAnswers()[t]}variablePlaceholder(t){return t===this.ALWAYS||t===this.PLEASE_SELECT?"x":t}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-editor-condition"]],viewQuery:function(e,i){e&1&&(Z(i.content,Et,5,Ue),Z(i.keywordTemplate,gt,5,B),Z(i.variableTemplate,Tt,5,B),Z(i.selectTemplate,vt,5,B)),e&2&&Ce(4)},inputs:{condition:[1,"condition"],selectVariables:[1,"selectVariables"]},outputs:{conditionChanged:"conditionChanged"},decls:8,vars:0,consts:[["content",""],["keyword",""],["variable",""],["select",""],["selectbox",""],[1,"font-bold"],[1,"font-mono",3,"ngClass"],[1,"font-mono",3,"change"],[3,"value"],[3,"value","selected","disabled"]],template:function(e,i){e&1&&(nt(0,null,0),g(2,Rt,2,1,"ng-template",null,1,Ee)(4,It,2,6,"ng-template",null,2,Ee)(6,At,4,4,"ng-template",null,3,Ee))},dependencies:[k],styles:["[_nghost-%COMP%]{display:flex;flex-direction:row;gap:8px;flex-wrap:wrap;align-items:center}"],changeDetection:0})};function qt(n,t){if(n&1&&(a(0,"option",4),I(1),r()),n&2){let e=t.$implicit;u("value",e),c(),U(e)}}function Pt(n,t){n&1&&(a(0,"span"),v(1,0),r()),n&2&&(c(),Q(t),G(1))}function Vt(n,t){n&1&&(a(0,"span"),v(1,1),r())}function Dt(n,t){if(n&1&&g(0,Pt,2,1,"span")(1,Vt,2,0,"span"),n&2){let e,i=l(2);m((e=i.form.controls.name.errors==null?null:i.form.controls.name.errors.pattern)?0:-1,e),c(),m(i.form.controls.name.errors!=null&&i.form.controls.name.errors.required?1:-1)}}function Ft(n,t){if(n&1&&(a(0,"div",7),g(1,Dt,2,2),r()),n&2){let e=l();c(),m(e.form.controls.name.touched?1:-1)}}var Ae=class n{item=f.required();state=C(y);mode=this.state.signal("rulesMode");categories=this.state.signal("categories");itemChanged=A();fb=C(we).nonNullable;form=this.fb.group({category:this.fb.control(""),name:this.fb.control("",{validators:[this.validateNamePattern(),pe.required.bind(this)]})});parser=C(z);serializer=C(F);constructor(){P(()=>{this.item(),this.reset()});let t=ve(this.form.valueChanges.pipe(de(500),ue(()=>this.form.valid)));P(()=>{let e=t();if(!e?.name)return;if(!e.category){this.addNewCategory();return}let i=this.serializer.serialize(new H(e.category,e.name));this.itemChanged.emit(this.parser.parseItem(i))}),P(()=>{this.mode()==="edit"?this.form.enable({emitEvent:!1}):this.form.disable({emitEvent:!1}),this.reset()})}blockPatch=!1;reset(){if(!this.blockPatch){let t=this.item().name;this.item().weight&&(t+=` ${this.serializer.serializeWeight(this.item().weight)}`),this.form.patchValue({category:this.item().category,name:t},{emitEvent:!1})}}focus(t){this.blockPatch=document.activeElement===t.target,this.form.controls.name.value===H.NEW_ITEM_NAME&&this.form.controls.name.setValue("",{emitEvent:!1})}blur(){this.blockPatch=!1,this.reset()}async addNewCategory(t=""){let e=await ct("Enter new category name",t);if(e)try{this.parser.validateCategoryName(e),this.form.patchValue({category:e})}catch(i){if(i instanceof Y){let o=i.found;await ze($localize`:@@edit.item.category.invalid-character:Category name cannot contain '${o}:INTERPOLATION:'`)}else console.error(i),await ze($localize`:@@edit.item.category.invalid:Invalid category name`);this.addNewCategory(e)}else this.reset()}validateNamePattern(){return t=>{let e=t.value?.trim()??"";try{return this.parser.validateItemNameAndWeight(e),null}catch(i){return t.markAsTouched(),i instanceof Y?{pattern:i.found}:{pattern:!0}}}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-editor-item"]],inputs:{item:[1,"item"]},outputs:{itemChanged:"itemChanged"},decls:8,vars:2,consts:()=>{let t;t=$localize`:@@edit.item.name.invalid-character:Item name cannot contain the character '${"\uFFFD0\uFFFD"}:INTERPOLATION:'`;let e;return e=$localize`:@@edit.item.name.required:Item name is required`,[t,e,[1,"flex",3,"formGroup"],["name","categories","formControlName","category",1,"max-w-24"],[3,"value"],["value",""],["type","text","formControlName","name",1,"w-0","flex-1",3,"focus","blur"],[1,"m-1","text-sm","text-red-light"]]},template:function(e,i){e&1&&(a(0,"form",2)(1,"select",3),L(2,qt,2,2,"option",4,it),a(4,"option",5),I(5,"+"),r()(),a(6,"input",6),_("focus",function(s){return i.focus(s)})("blur",function(){return i.blur()}),r()(),g(7,Ft,2,1,"div",7)),e&2&&(u("formGroup",i.form),c(2),$(i.categories()),c(5),m(i.mode()==="edit"&&i.form.valid===!1&&i.form.touched?7:-1))},dependencies:[xe,be,dt,ft,K,ut,J,Se,Re,Ie],encapsulation:2,changeDetection:0})};var Lt=(n,t,e)=>({"font-bold":n,"text-green-light":t,"text-red-light":e});function $t(n,t){n&1&&(a(0,"span"),v(1,0),r()),n&2&&(c(),Q(t),G(1))}function Qt(n,t){n&1&&(a(0,"span"),v(1,1),r())}function Gt(n,t){n&1&&(a(0,"span"),v(1,2),r())}function Ut(n,t){if(n&1&&(a(0,"span"),v(1,3),r()),n&2){let e=l();c(),Q(e),G(1)}}function kt(n,t){n&1&&g(0,Gt,2,0,"span")(1,Ut,2,1,"span"),n&2&&m(t===" "?0:1)}function zt(n,t){n&1&&(a(0,"span"),v(1,4),r())}function Bt(n,t){n&1&&(a(0,"span"),v(1,5),r())}function Xt(n,t){n&1&&(a(0,"span"),v(1,6),r())}function Zt(n,t){if(n&1&&(a(0,"div",12),g(1,$t,2,1,"span")(2,Qt,2,0,"span")(3,kt,2,1)(4,zt,2,0,"span")(5,Bt,2,0,"span")(6,Xt,2,0,"span"),r()),n&2){let e,i,o=l();c(),m((e=o.form.controls.question.errors==null?null:o.form.controls.question.errors.pattern)?1:-1,e),c(),m(o.form.controls.question.errors!=null&&o.form.controls.question.errors.required?2:-1),c(),m((i=o.form.controls.variable.errors==null?null:o.form.controls.variable.errors.pattern)?3:-1,i),c(),m(o.form.controls.variable.errors!=null&&o.form.controls.variable.errors.required?4:-1),c(),m(o.form.controls.variable.errors!=null&&o.form.controls.variable.errors.reserved?5:-1),c(),m(o.form.controls.variable.errors!=null&&o.form.controls.variable.errors.used?6:-1)}}var qe=class n{question=f.required();parser=C(z);state=C(y);variables=this.state.signal("variables");mode=this.state.signal("rulesMode");highlighVariable=w(()=>this.mode()!=="edit"&&this.state.signal("highlightVariableStatus")());variableActive=w(()=>this.state.signal("activeAnswers")()[this.question().variable]);refactorVariables=this.state.signal("refactorVariables");questionChanged=A();variableChanged=A();fb=C(we).nonNullable;form=this.fb.group({question:this.fb.control("",{validators:[this.validateQuestionPattern(),pe.required.bind(this)]}),variable:this.fb.control("",{validators:[this.validateVariablePattern(),Wt(),pe.required.bind(this)],asyncValidators:[Ht(Be(this.variables),Be(this.question))]})});constructor(){P(()=>{this.question(),this.reset()});let t=ve(this.form.valueChanges.pipe(de(500),ue(()=>this.form.valid)));P(()=>{let e=t();e?.question&&e.question!==this.question().question&&e.variable?this.questionChanged.emit(new V(e.question,e.variable)):e?.variable&&e.variable.trim()!==this.question().variable&&(this.question().variable===V.NEW_VARIABLE_NAME||!this.refactorVariables()?this.questionChanged.emit(new V(this.question().question,e.variable.trim())):this.variableChanged.emit([this.question().variable,e.variable.trim()]))}),P(()=>{this.mode()==="edit"?this.form.enable({emitEvent:!1}):this.form.disable({emitEvent:!1}),this.reset()})}reset(){this.form.patchValue(this.question(),{emitEvent:!1})}focusQuestion(){this.form.controls.question.value===V.NEW_QUESTION_NAME&&this.form.controls.question.setValue("",{emitEvent:!1})}focusVariable(){this.form.controls.variable.value===V.NEW_VARIABLE_NAME&&this.form.controls.variable.setValue("",{emitEvent:!1})}validateVariablePattern(){return t=>{let e=t.value?.trim()??"";try{return this.parser.validateVariableName(e),null}catch(i){return t.markAsTouched(),i instanceof Y?{pattern:i.found}:{pattern:!0}}}}validateQuestionPattern(){return t=>{let e=t.value?.trim()??"";try{return this.parser.validateQuestionString(e),null}catch(i){return t.markAsTouched(),i instanceof Y?{pattern:i.found}:{pattern:!0}}}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-editor-question"]],inputs:{question:[1,"question"]},outputs:{questionChanged:"questionChanged",variableChanged:"variableChanged"},decls:7,vars:7,consts:()=>{let t;t=$localize`:@@edit.question.question.placeholder:question`;let e;e=$localize`:@@edit.question.variable.placeholder:variable`;let i;i=$localize`:@@edit.question.question.invalid-character:Questions cannot contain this character: '${"\uFFFD0\uFFFD"}:INTERPOLATION:'`;let o;o=$localize`:@@edit.question.question.required:Question is required`;let s;s=$localize`:@@edit.question.variable.invalid-spaces:Variables cannot contain spaces`;let R;R=$localize`:@@edit.question.variable.invalid-character:Variables cannot contain this character: '${"\uFFFD0\uFFFD"}:INTERPOLATION:'`;let M;M=$localize`:@@edit.question.variable.required:Variable name is required`;let re;re=$localize`:@@edit.question.variable.reserved:This variable name is reserved`;let me;return me=$localize`:@@edit.question.variable.used:This variable name is already used`,[i,o,s,R,M,re,me,[1,"flex","flex-col",3,"formGroup"],["type","text","placeholder",t,"formControlName","question",1,"grow",3,"focus"],[1,"flex","items-center","gap-2"],[1,"ml-3","text-nowrap","font-mono"],["type","text","placeholder",e,"formControlName","variable",1,"grow","font-mono",3,"focus","ngClass"],[1,"m-1","flex","flex-col","text-sm","text-red-light"]]},template:function(e,i){e&1&&(a(0,"form",7)(1,"input",8),_("focus",function(){return i.focusQuestion()}),r(),a(2,"div",9)(3,"span",10),I(4,"->"),r(),a(5,"input",11),_("focus",function(){return i.focusVariable()}),r()(),g(6,Zt,7,6,"div",12),r()),e&2&&(u("formGroup",i.form),c(5),u("ngClass",he(3,Lt,i.highlighVariable(),i.highlighVariable()&&i.variableActive(),i.highlighVariable()&&!i.variableActive())),c(),m(i.mode()==="edit"&&i.form.valid===!1&&i.form.touched?6:-1))},dependencies:[xe,be,K,J,Se,Re,Ie,k],encapsulation:2,changeDetection:0})};function Wt(){return n=>[j.string,Xe,Ze,We,He].some(t=>t===n.value?.trim())?{reserved:!0}:null}function Ht(n,t){return e=>_e(e.value).pipe(Je(n.pipe(Ge(i=>[...i])),t),Ke(([i,o,s])=>Ye(()=>!o.find(R=>R===s.variable),_e(null),_e([i,o,s]).pipe(Ge(([R,M,re])=>{let me=M.findIndex(q=>q===re.variable);return M.splice(me,1),M.includes(R?.trim()??"")?{used:!0}:null})))))}var ne=class n{serializer=C(F);parser=C(z);state=C(y);questions=this.state.signal("clipboardQuestions");items=this.state.signal("clipboardItems");itemsCount=w(()=>this.items().length);questionsCount=w(()=>this.questions().length);cutQuestion(t){this.questions.update(e=>[...e,this.serializer.serialize(t)])}cutItem(t){this.items.update(e=>[...e,this.serializer.serialize(t)])}paste(){let t={questions:this.questions().map(e=>this.parser.parseQuestion(e)),items:this.items().map(e=>this.parser.parseItem(e))};return this.questions.set([]),this.items.set([]),t}static \u0275fac=function(e){return new(e||n)};static \u0275prov=et({token:n,factory:n.\u0275fac,providedIn:"root"})};function jt(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l();return E(o.resetCondition())}),p(1,"app-icon-clear"),r()}}function Yt(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l(2).$index,s=l();return E(s.swapQuestions(o,o+1))}),p(1,"app-icon-down"),r()}}function Kt(n,t){n&1&&p(0,"span",9)}function Jt(n,t){if(n&1&&g(0,Yt,2,0,"button",4)(1,Kt,1,0,"span",9),n&2){let e=l().$index,i=l();m(e<i.rule().questions.length-1?0:1)}}function ei(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l().$index,s=l();return E(s.deleteQuestion(o))}),p(1,"app-icon-delete"),r()}}function ti(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l().$index,s=l();return E(s.cutQuestion(o))}),p(1,"app-icon-cut"),r()}}function ii(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l().$index,s=l();return E(s.swapQuestions(o-1,o))}),p(1,"app-icon-up"),r()}}function ni(n,t){if(n&1){let e=T();a(0,"div",2),g(1,Jt,2,1),a(2,"app-editor-question",8),_("questionChanged",function(o){let s=h(e).$index,R=l();return E(R.updateQuestion(s,o))})("variableChanged",function(o){h(e);let s=l();return E(s.variableChanged(o))}),r(),g(3,ei,2,0,"button",4)(4,ti,2,0,"button",4)(5,ii,2,0,"button",4),r()}if(n&2){let e=t.$implicit,i=t.$index,o=l();c(),m(o.mode()==="swap"?1:-1),c(),u("question",e),c(),m(o.mode()==="delete"?3:o.mode()==="cut-paste"?4:o.mode()==="swap"&&i>0?5:-1)}}function oi(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l(2).$index,s=l();return E(s.swapItems(o,o+1))}),p(1,"app-icon-down"),r()}}function ri(n,t){n&1&&p(0,"span",9)}function ai(n,t){if(n&1&&g(0,oi,2,0,"button",4)(1,ri,1,0,"span",9),n&2){let e=l().$index,i=l();m(e<i.rule().items.length-1?0:1)}}function si(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l().$index,s=l();return E(s.deleteItem(o))}),p(1,"app-icon-delete"),r()}}function li(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l().$index,s=l();return E(s.cutItem(o))}),p(1,"app-icon-cut"),r()}}function ci(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l().$index,s=l();return E(s.swapItems(o-1,o))}),p(1,"app-icon-up"),r()}}function pi(n,t){if(n&1){let e=T();a(0,"div",2),g(1,ai,2,1),a(2,"app-editor-item",10),_("itemChanged",function(o){let s=h(e).$index,R=l();return E(R.updateItem(s,o))}),r(),g(3,si,2,0,"button",4)(4,li,2,0,"button",4)(5,ci,2,0,"button",4),r()}if(n&2){let e=t.$implicit,i=t.$index,o=l();c(),m(o.mode()==="swap"?1:-1),c(),u("item",e),c(),m(o.mode()==="delete"?3:o.mode()==="cut-paste"?4:o.mode()==="swap"&&i>0?5:-1)}}function mi(n,t){if(n&1){let e=T();a(0,"div",5)(1,"button",11),_("click",function(){h(e);let o=l();return E(o.addQuestion())}),v(2,0),r(),a(3,"button",11),_("click",function(){h(e);let o=l();return E(o.addItem())}),v(4,1),r()()}}function _i(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l(2);return E(o.deleteRule.emit())}),p(1,"app-icon-delete"),r()}}function ui(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l(2);return E(o.paste())}),p(1,"app-icon-paste"),r()}}function di(n,t){if(n&1&&(a(0,"div",6),g(1,_i,2,0,"button",4)(2,ui,2,0,"button",4),r()),n&2){let e=l();c(),m(e.mode()==="delete"?1:-1),c(),m(e.mode()==="cut-paste"?2:-1)}}function fi(n,t){if(n&1&&(a(0,"pre"),I(1),r(),a(2,"pre"),I(3),r()),n&2){let e=l();c(),U(t),c(2),U(e.ruleDebugString())}}var Pe=class n{rule=f.required();ruleChanged=A();deleteRule=A();renameVariable=A();ruleDebugString=w(()=>this.serializer.serialize(this.rule()));errorMessage=fe(null);state=C(y);mode=this.state.signal("rulesMode");selectVariables=w(()=>{let t=this.rule().questions.map(i=>i.variable);return this.state.get("variables").filter(i=>!t.includes(i))});clipboard=C(ne);parser=C(z);serializer=C(F);compileRule(t){try{return this.parser.parseRule(this.serializer.serialize(t)),this.errorMessage.set(null),!0}catch(e){return e instanceof Error&&this.errorMessage.set(e.message),!1}}resetCondition(){this.updateCondition(new D)}updateCondition(t){let e=new W(t,this.rule().questions,this.rule().items);this.compileRule(e)&&this.ruleChanged.emit(e)}emitNewQuestions(t){let e=new W(this.rule().condition,t,this.rule().items);this.compileRule(e)&&this.ruleChanged.emit(e)}updateQuestion(t,e){let i=this.rule().questions;i[t]=e,this.emitNewQuestions(i)}addQuestion(){let t=new V(V.NEW_QUESTION_NAME,V.NEW_VARIABLE_NAME);this.updateQuestion(this.rule().questions.length,t)}deleteQuestion(t){let e=this.rule().questions;e.splice(t,1),this.emitNewQuestions(e)}cutQuestion(t){let e=this.rule().questions[t];this.deleteQuestion(t),this.clipboard.cutQuestion(e)}swapQuestions(t,e){let i=this.rule().questions,o=i[t];i[t]=i[e],i[e]=o,this.emitNewQuestions(i)}emitNewItems(t){let e=new W(this.rule().condition,this.rule().questions,t);this.compileRule(e)&&this.ruleChanged.emit(e)}updateItem(t,e){let i=this.rule().items;i[t]=e,this.emitNewItems(i)}addItem(){let t=new H(H.NEW_CATEGORY_NAME,H.NEW_ITEM_NAME);this.updateItem(this.rule().items.length,t)}deleteItem(t){let e=this.rule().items;e.splice(t,1),this.emitNewItems(e)}cutItem(t){let e=this.rule().items[t];this.deleteItem(t),this.clipboard.cutItem(e)}swapItems(t,e){let i=this.rule().items,o=i[t];i[t]=i[e],i[e]=o,this.emitNewItems(i)}paste(){let{questions:t,items:e}=this.clipboard.paste(),i=new W(this.rule().condition,[...this.rule().questions,...t],[...this.rule().items,...e]);this.ruleChanged.emit(i)}variableChanged([t,e]){this.renameVariable.emit([t,e])}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-editor-rule"]],inputs:{rule:[1,"rule"]},outputs:{ruleChanged:"ruleChanged",deleteRule:"deleteRule",renameVariable:"renameVariable"},decls:10,vars:5,consts:()=>{let t;t=$localize`:@@edit.rules.add-question: + Question `;let e;return e=$localize`:@@edit.rules.add-item: + Item `,[t,e,[1,"mb-1","flex","items-center"],[1,"grow",3,"conditionChanged","condition","selectVariables"],["type","button",1,"link"],[1,"flex","justify-end","gap-2"],[1,"flex","justify-center"],["type","button",1,"link",3,"click"],[1,"grow",3,"questionChanged","variableChanged","question"],[1,"ml-6"],[1,"grow",3,"itemChanged","item"],["type","button",3,"click"]]},template:function(e,i){if(e&1&&(a(0,"div",2)(1,"app-editor-condition",3),_("conditionChanged",function(s){return i.updateCondition(s)}),r(),g(2,jt,2,0,"button",4),r(),L(3,ni,6,3,"div",2,ae),L(5,pi,6,3,"div",2,ae),g(7,mi,5,0,"div",5)(8,di,3,2,"div",6)(9,fi,4,2)),e&2){let o;c(),u("condition",i.rule().condition)("selectVariables",i.selectVariables()),c(),m(i.mode()==="edit"?2:-1),c(),$(i.rule().questions),c(2),$(i.rule().items),c(2),m(i.mode()==="edit"?7:8),c(2),m((o=i.errorMessage())?9:-1,o)}},dependencies:[Me,qe,Ae,ie,Ne,ye,Oe,pt,te],encapsulation:2,changeDetection:0})};var Ve=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-edit"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var De=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-reorder"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M160-501q0 71 47.5 122T326-322l-62-62 56-56 160 160-160 160-56-56 64-64q-105-6-176.5-81T80-500q0-109 75.5-184.5T340-760h140v80H340q-75 0-127.5 52T160-501Zm400 261v-80h320v80H560Zm0-220v-80h320v80H560Zm0-220v-80h320v80H560Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var Fe=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-search"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var Le=class n{class=f("h-4 w-4");static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-icon-view"]],inputs:{class:[1,"class"]},decls:2,vars:2,consts:[["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"]],template:function(e,i){e&1&&(S(),a(0,"svg",0),p(1,"path",1),r()),e&2&&b(i.class())},encapsulation:2,changeDetection:0})};var Ci=["searchInput"],hi=n=>({"sticky left-0 top-0 z-30 shadow-md":n}),oe=n=>({active:n}),$e=n=>({"fill-slate-400":n});function Ei(n,t){n&1&&(a(0,"span"),v(1,2),r())}function gi(n,t){if(n&1&&(a(0,"span"),v(1,3),r()),n&2){let e=t;c(),Q(e)(e),G(1)}}function Ti(n,t){if(n&1&&(a(0,"span"),v(1,4),r()),n&2){let e=t;c(),Q(e)(e),G(1)}}function vi(n,t){if(n&1&&g(0,gi,2,2,"span")(1,Ti,2,2,"span"),n&2){let e,i,o=l(2);m((e=o.clipboard.itemsCount())?0:-1,e),c(),m((i=o.clipboard.questionsCount())?1:-1,i)}}function Si(n,t){if(n&1&&(a(0,"div",11)(1,"span"),v(2,1),r(),g(3,Ei,2,0,"span")(4,vi,2,2),r()),n&2){let e=l();c(3),m(e.clipboard.itemsCount()===0&&e.clipboard.questionsCount()===0?3:4)}}function bi(n,t){if(n&1){let e=T();a(0,"div",12)(1,"input",13,0),st("ngModelChange",function(o){h(e);let s=l();return at(s.searchTerm,o)||(s.searchTerm=o),E(o)}),r(),a(3,"button",14),_("click",function(){h(e);let o=l();return E(o.clearSearch())}),p(4,"app-icon-clear"),r()()}if(n&2){let e=l();c(),rt("ngModel",e.searchTerm)}}var Qe=class n{noOfVisibleRules=f.required();state=C(y);mode=this.state.signal("rulesMode");searchTerm=this.state.signal("filterRulesQuery");clipboard=C(ne);sticky=w(()=>this.state.signal("scrollY")()>48);searchInput=X.required("searchInput");focusSearch(){setTimeout(()=>{this.searchInput().nativeElement.focus()},50)}clearSearch(){this.searchTerm.set(""),this.focusSearch()}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-toolbar"]],viewQuery:function(e,i){e&1&&Z(i.searchInput,Ci,5),e&2&&Ce()},inputs:{noOfVisibleRules:[1,"noOfVisibleRules"]},decls:16,vars:38,consts:()=>{let t;t=$localize`:@@edit.toolbar.clipboard:Clipboard:`;let e;e=$localize`:@@edit.toolbar.clipboard.empty:empty`;let i;i=$localize`:@@edit.toolbar.clipboard.items:{VAR_PLURAL, plural, one {1 Item} other {{INTERPOLATION} Items}}`,i=ke(i,{INTERPOLATION:"\uFFFD1\uFFFD",VAR_PLURAL:"\uFFFD0\uFFFD"});let o;return o=$localize`:@@edit.toolbar.clipboard.questions:{VAR_PLURAL, plural, one {1 Question} other {{INTERPOLATION} Questions}}`,o=ke(o,{INTERPOLATION:"\uFFFD1\uFFFD",VAR_PLURAL:"\uFFFD0\uFFFD"}),[["searchInput",""],t,e,i,o,[1,"bg-active","py-2",3,"ngClass"],[1,"mb-1","grid","grid-cols-6","gap-2"],["type","button",1,"link",3,"click","ngClass"],[1,"my-auto","h-6","w-6"],["type","button",1,"link",3,"click","ngClass","disabled"],[1,"my-auto","h-6","w-6",3,"ngClass"],[1,"mt-2","flex","justify-center","gap-5"],[1,"mt-2","flex","items-center"],["type","text",1,"grow",3,"ngModelChange","ngModel"],["type","button",1,"icon","m-3",3,"click"]]},template:function(e,i){e&1&&(a(0,"div",5)(1,"div",6)(2,"button",7),_("click",function(){return i.mode.set("view")}),p(3,"app-icon-view",8),r(),a(4,"button",9),_("click",function(){return i.mode.set("edit")}),p(5,"app-icon-edit",10),r(),a(6,"button",9),_("click",function(){return i.mode.set("delete")}),p(7,"app-icon-delete",10),r(),a(8,"button",9),_("click",function(){return i.mode.set("cut-paste")}),p(9,"app-icon-reorder",10),r(),a(10,"button",9),_("click",function(){return i.mode.set("swap")}),p(11,"app-icon-swap",10),r(),a(12,"button",7),_("click",function(){return i.mode.set("search"),i.focusSearch()}),p(13,"app-icon-search",8),r()(),g(14,Si,5,1,"div",11)(15,bi,5,1,"div",12),r()),e&2&&(u("ngClass",O(16,hi,i.sticky())),c(2),u("ngClass",O(18,oe,i.mode()==="view")),c(2),u("ngClass",O(20,oe,i.mode()==="edit"))("disabled",!i.noOfVisibleRules()&&!!i.searchTerm()),c(),u("ngClass",O(22,$e,!i.noOfVisibleRules()&&!!i.searchTerm())),c(),u("ngClass",O(24,oe,i.mode()==="delete"))("disabled",!i.noOfVisibleRules()),c(),u("ngClass",O(26,$e,!i.noOfVisibleRules())),c(),u("ngClass",O(28,oe,i.mode()==="cut-paste"))("disabled",i.noOfVisibleRules()<2),c(),u("ngClass",O(30,$e,i.noOfVisibleRules()<2)),c(),u("ngClass",O(32,oe,i.mode()==="swap"))("disabled",!i.noOfVisibleRules()),c(),u("ngClass",O(34,$e,!i.noOfVisibleRules())),c(),u("ngClass",O(36,oe,i.mode()==="search")),c(2),m(i.mode()==="cut-paste"?14:i.mode()==="search"||i.searchTerm()?15:-1))},dependencies:[Ct,K,J,_t,k,Le,Ve,ie,De,ee,Fe,te],encapsulation:2,changeDetection:0})};var Ri=(n,t)=>t.index,Ii=(n,t)=>({disabled:n,"animate-pulse":t});function wi(n,t){if(n&1){let e=T();a(0,"div",3)(1,"button",6),_("click",function(){h(e);let o=l().$implicit,s=l();return E(s.swapRules(o.index-1,o.index))}),p(2,"app-icon-swap"),r()()}}function xi(n,t){if(n&1){let e=T();g(0,wi,3,0,"div",3),a(1,"div",4)(2,"app-editor-rule",5),_("ruleChanged",function(o){let s=h(e).$implicit,R=l();return E(R.updateRule(s.index,o))})("deleteRule",function(){let o=h(e).$implicit,s=l();return E(s.deleteRule(o.index))})("renameVariable",function(o){h(e);let s=l();return E(s.renameVariable(o))}),r()()}if(n&2){let e=t.$implicit,i=l();m(e.index>0&&i.mode()==="swap"&&!i.filter()?0:-1),c(),u("id","rule-"+e.index)("ngClass",lt(4,Ii,i.showAsDisabled(e.rule),i.highlightRule()===e.index)),c(),u("rule",e.rule)}}function Ni(n,t){if(n&1){let e=T();a(0,"button",7),_("click",function(){h(e);let o=l();return E(o.addRule())}),v(1,0),r()}}var je=class n{serializer=C(F);refactor=C(mt);state=C(y);parsedRules=this.state.signal("parsedRules");activeRules=this.state.signal("activeRules");mode=this.state.signal("rulesMode");filter=this.state.signal("filterRulesQuery");highlightRule=fe(void 0);visibleRules=w(()=>this.filter()===""?this.parsedRules().map((e,i)=>({rule:e,index:i})):this.parsedRules().map((e,i)=>({rule:e,index:i})).filter(e=>{let i=this.filter();return!i||this.refactor.contains(e.rule,i)}));updateRules(t){let e=this.serializer.serializeRules(t);this.state.set("rules",e)}updateRule(t,e){let i=this.parsedRules();i[t]=e,this.updateRules([...i])}deleteRule(t){let e=this.parsedRules();e.splice(t,1),this.updateRules([...e])}addRule(){let t=this.parsedRules().length,e=[];for(let s=0;s<this.parsedRules().length;s++){let R=document.querySelector(`#rule-${s.toString()}`);if(R){let M=R.getBoundingClientRect();M.top>=0&&M.bottom<=window.innerHeight&&e.push(s)}}e.includes(t-1)||(t=e[0]+1);let i=new W(new D),o=this.parsedRules();o.splice(t,0,i),this.updateRules([...o]),this.highlightRule.set(t),setTimeout(()=>{this.highlightRule.set(void 0)},4e3)}swapRules(t,e){let i=this.parsedRules(),o=i[t];i[t]=i[e],i[e]=o,this.updateRules([...i])}showAsDisabled(t){return this.state.get("fadeOutDisabledRules")&&!this.activeRules().includes(t)}renameVariable([t,e]){let i=this.refactor.renameVariable(t,e,this.parsedRules());this.updateRules(i)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=d({type:n,selectors:[["app-rules"]],decls:4,vars:2,consts:()=>{let t;return t=$localize`:@@edit.rules.add-rule: + Rule `,[t,[3,"noOfVisibleRules"],["type","button",1,"sticky","bottom-0","z-50"],[1,"flex","justify-center"],[1,"card","mb-1",3,"id","ngClass"],[3,"ruleChanged","deleteRule","renameVariable","rule"],["type","button",1,"link",3,"click"],["type","button",1,"sticky","bottom-0","z-50",3,"click"]]},template:function(e,i){e&1&&(p(0,"app-toolbar",1),L(1,xi,3,7,null,null,Ri),g(3,Ni,2,0,"button",2)),e&2&&(u("noOfVisibleRules",i.visibleRules().length),c(),$(i.visibleRules()),c(2),m(i.mode()==="edit"&&!i.filter()?3:-1))},dependencies:[Pe,Qe,ee,k],encapsulation:2,changeDetection:0})};export{je as default};
