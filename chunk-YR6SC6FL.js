import{c as et,d as Le}from"./chunk-R2QRPLUN.js";import{c as tt,d as it,e as nt,g as pe,i as ot,j as Ce,l as rt,r as at,s as lt,t as st,u as fe,v as _t}from"./chunk-HJEUUZA3.js";import{a as $e,b as ge,d as j,e as re,f as Y,g as Te,h as dt,i as Re,l as be,m as Se,n as ct,o as mt,p as pt,q as ve,r as Ct,s as Oe}from"./chunk-HVFS2GKV.js";import{a as z,b as P,c as X,d as Ee,e as y,f as ie,g as he,h as ne,i as oe,j as W,l as Q,m as M,n as ut,o as v}from"./chunk-WU25SZS2.js";import{c as D,l as Ze}from"./chunk-TNXYQ7TE.js";import{Ab as d,B as _e,Bb as s,E as ue,Fb as k,Gb as ce,Ha as _,Hb as Ye,Ib as b,Jb as F,Ka as U,Kb as te,Mb as Ke,Na as Me,Nb as He,Oa as de,Ob as Je,Pa as G,Q as ke,Sa as O,T as ze,Tb as S,Ub as B,W as Xe,Xb as me,Ya as m,aa as p,eb as c,ec as R,gb as Be,gc as w,ib as u,ja as C,jb as ee,ka as f,kb as We,l as se,lb as V,mb as L,nb as l,ob as a,p as ye,pb as E,qb as je,rb as h,ua as x,va as N,wb as g,x as Ge,xb as $,yb as q,zb as Ve}from"./chunk-6EH5NXRP.js";import"./chunk-2NFLSA4Y.js";var Et=["content"],ht=["keyword"],gt=["variable"],Tt=["select"],Rt=(n,t,e)=>({"font-bold":n,"text-green-light":t,"text-red-light":e}),bt=n=>({width:n});function St(n,t){if(n&1&&(l(0,"span",5),b(1),a()),n&2){let e=t.$implicit;_(),F(e)}}function vt(n,t){if(n&1&&(l(0,"span",6),b(1),a()),n&2){let e=t.$implicit,i=s();c("ngClass",B(2,Rt,i.highlighVariable(),i.highlighVariable()&&i.variableActive(e),i.highlighVariable()&&!i.variableActive(e))),_(),F(e)}}function Ot(n,t){if(n&1&&(l(0,"option",8),b(1),a()),n&2){let e=s(2).$implicit,i=s();c("value",i.NOT),_(),te("NOT ",i.variablePlaceholder(e),"")}}function It(n,t){if(n&1&&(l(0,"option",8),b(1),a()),n&2){let e=s(2).$implicit,i=s();c("value",i.AND),_(),te("",i.variablePlaceholder(e)," AND x")}}function xt(n,t){if(n&1&&(l(0,"option",8),b(1),a()),n&2){let e=s(2).$implicit,i=s();c("value",i.OR),_(),te("",i.variablePlaceholder(e)," OR x")}}function Nt(n,t){if(n&1&&(l(0,"option",8),b(1,"REMOVE"),a()),n&2){let e=s(4);c("value",e.REMOVE)}}function At(n,t){if(n&1&&m(0,Nt,2,1,"option",8),n&2){let e=s(2).$implicit,i=s();u(e!==i.PLEASE_SELECT?0:-1)}}function wt(n,t){if(n&1&&(l(0,"option",9),b(1),a()),n&2){let e=s().$implicit,i=s().$implicit,o=s();c("value",e)("selected",i===e)("disabled",e===o.PLEASE_SELECT),_(),te(" ",e," ")}}function Pt(n,t){if(n&1&&m(0,Ot,2,2,"option",8)(1,It,2,2,"option",8)(2,xt,2,2,"option",8)(3,At,1,1)(4,wt,2,4,"option",9),n&2){let e,i=t.$implicit,o=s(2);u((e=i)===o.NOT?0:e===o.AND?1:e===o.OR?2:e===o.REMOVE?3:4)}}function yt(n,t){if(n&1){let e=h();l(0,"select",7,4),d("change",function(){let o=C(e),r=o.$implicit,T=o.selection,I=Ye(1);return f(T(I.value,r))}),V(2,Pt,5,1,null,null,ee),a()}if(n&2){let e=t.options,i=t.width;Be(S(2,bt,i)),_(2),L(e)}}var qe="NOT",Fe="AND",De="OR",Qe="REMOVE",Ie=class n{condition=N.required();selectVariables=N.required();content=G.required("content",{read:Me});keywordTemplate=G.required("keyword",{read:U});variableTemplate=G.required("variable",{read:U});selectTemplate=G.required("select",{read:U});state=p(v);activeAnswers=this.state.signal("activeAnswers");mode=this.state.signal("rulesMode");highlighVariable=R(()=>this.mode()!=="edit"&&this.state.signal("highlightVariableStatus")());serializer=p(M);serializedCondition=R(()=>this.serializer.serialize(this.condition()));PLEASE_SELECT=y.string;ALWAYS=ie.string;NOT=qe;AND=Fe;OR=De;REMOVE=Qe;conditionChanged=x();constructor(){w(()=>{this.mode(),this.condition(),this.selectVariables(),this.repaint()})}repaint(){this.content().clear(),this.paintKeyword("IF"),this.paintCondition(this.condition(),t=>{t?this.conditionChanged.emit(t):this.conditionChanged.emit(new y)})}calculateOptions(t){return[this.PLEASE_SELECT,this.ALWAYS,...this.selectVariables(),this.NOT,this.AND,this.OR,this.REMOVE].filter(e=>!t.includes(e))}createFromPrevious(t){return t===this.PLEASE_SELECT||t===this.ALWAYS?new y:new Ee(t)}selection(t,e){return t===this.NOT?new he(this.createFromPrevious(e)):t===this.AND?new ne(this.createFromPrevious(e),new y):t===this.OR?new oe(this.createFromPrevious(e),new y):t===this.REMOVE?null:t===this.ALWAYS?new ie:new Ee(t)}paintKeyword(t){this.content().createEmbeddedView(this.keywordTemplate(),{$implicit:t})}paintSelect(t,e,i){this.content().createEmbeddedView(this.selectTemplate(),{$implicit:t,options:this.calculateOptions(i),selection:(o,r)=>{e(this.selection(o,r))},width:(t.length*9+30).toString()+"px"})}paintVariable(t){this.content().createEmbeddedView(this.variableTemplate(),{$implicit:t})}paintCondition(t,e,i=[]){if(t instanceof he){let o=i.filter(r=>r!==this.ALWAYS);this.paintKeyword("NOT"),this.paintCondition(t.not,r=>{e(r?new he(r):null)},o)}else if(t instanceof ne){let o=[...i,this.ALWAYS];this.paintCondition(t.left,r=>{e(r?new ne(r,t.right):t.right)},o),this.paintKeyword("AND"),this.paintCondition(t.right,r=>{e(r?new ne(t.left,r):t.left)},o)}else if(t instanceof oe){let o=[...i,this.ALWAYS];this.paintCondition(t.left,r=>{e(r?new oe(r,t.right):t.right)},o),this.paintKeyword("OR"),this.paintCondition(t.right,r=>{e(r?new oe(t.left,r):t.left)},o)}else t instanceof Ee&&(this.mode()==="edit"?this.paintSelect(t.variable,e,i):this.paintVariable(t.variable))}variableActive(t){return this.activeAnswers()[t]}variablePlaceholder(t){return t===this.ALWAYS||t===this.PLEASE_SELECT?"x":t}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=O({type:n,selectors:[["app-editor-condition"]],viewQuery:function(e,i){e&1&&(k(i.content,Et,5,Me),k(i.keywordTemplate,ht,5,U),k(i.variableTemplate,gt,5,U),k(i.selectTemplate,Tt,5,U)),e&2&&ce(4)},inputs:{condition:[1,"condition"],selectVariables:[1,"selectVariables"]},outputs:{conditionChanged:"conditionChanged"},decls:8,vars:0,consts:[["content",""],["keyword",""],["variable",""],["select",""],["selectbox",""],[1,"font-bold"],[1,"font-mono",3,"ngClass"],[1,"font-mono",3,"change"],[3,"value"],[3,"value","selected","disabled"]],template:function(e,i){e&1&&(je(0,null,0),m(2,St,2,1,"ng-template",null,1,me)(4,vt,2,6,"ng-template",null,2,me)(6,yt,4,4,"ng-template",null,3,me))},dependencies:[D],styles:["[_nghost-%COMP%]{display:flex;min-height:2rem;flex-direction:row;flex-wrap:wrap;align-items:center;justify-content:flex-start;gap:.5rem}"],changeDetection:0})};function Mt(n,t){if(n&1&&(l(0,"option",4),b(1),a()),n&2){let e=t.$implicit;c("value",e),_(),F(e)}}function Vt(n,t){n&1&&(l(0,"span"),g(1,0),a()),n&2&&(_(),$(t),q(1))}function Lt(n,t){n&1&&(l(0,"span"),g(1,1),a())}function $t(n,t){if(n&1&&m(0,Vt,2,1,"span")(1,Lt,2,0,"span"),n&2){let e,i=s(2);u((e=i.form.controls.name.errors==null?null:i.form.controls.name.errors.pattern)?0:-1,e),_(),u(i.form.controls.name.errors!=null&&i.form.controls.name.errors.required?1:-1)}}function qt(n,t){if(n&1&&(l(0,"div",7),m(1,$t,2,2),a()),n&2){let e=s();_(),u(e.form.controls.name.touched?1:-1)}}var xe=class n{item=N.required();state=p(v);mode=this.state.signal("rulesMode");categories=this.state.signal("categories");itemChanged=x();fb=p(ve).nonNullable;form=this.fb.group({category:this.fb.control(""),name:this.fb.control("",{validators:[this.validateNamePattern(),re.required.bind(this)]})});parser=p(Q);serializer=p(M);constructor(){w(()=>{this.item(),this.reset()});let t=ge(this.form.valueChanges.pipe(ue(500),_e(()=>this.form.valid)));w(()=>{let e=t();if(!e?.name)return;if(!e.category){this.addNewCategory();return}let i=this.serializer.serialize(new X(e.category,e.name));this.itemChanged.emit(this.parser.parseItem(i))}),w(()=>{this.mode()==="edit"?this.form.enable({emitEvent:!1}):this.form.disable({emitEvent:!1}),this.reset()})}blockPatch=!1;reset(){if(!this.blockPatch){let t=this.item().name;this.item().weight&&(t+=` ${this.serializer.serializeWeight(this.item().weight)}`),this.form.patchValue({category:this.item().category,name:t},{emitEvent:!1})}}focus(t){this.blockPatch=document.activeElement===t.target,this.form.controls.name.value===X.NEW_ITEM_NAME&&this.form.controls.name.setValue("",{emitEvent:!1})}blur(){this.blockPatch=!1,this.reset()}async addNewCategory(t=""){let e=await et("Enter new category name",t);if(e)try{this.parser.validateCategoryName(e),this.form.patchValue({category:e})}catch(i){if(i instanceof W){let o=i.found;await Le($localize`:@@edit.item.category.invalid-character:Category name cannot contain '${o}:INTERPOLATION:'`)}else console.error(i),await Le($localize`:@@edit.item.category.invalid:Invalid category name`);this.addNewCategory(e)}else this.reset()}validateNamePattern(){return t=>{let e=t.value?.trim()??"";try{return this.parser.validateItemNameAndWeight(e),null}catch(i){return t.markAsTouched(),i instanceof W?{pattern:i.found}:{pattern:!0}}}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=O({type:n,selectors:[["app-editor-item"]],inputs:{item:[1,"item"]},outputs:{itemChanged:"itemChanged"},decls:8,vars:2,consts:()=>{let t;t=$localize`:@@edit.item.name.invalid-character:Item name cannot contain the character '${"\uFFFD0\uFFFD"}:INTERPOLATION:'`;let e;return e=$localize`:@@edit.item.name.required:Item name is required`,[t,e,[1,"flex",3,"formGroup"],["name","categories","formControlName","category",1,"max-w-[5rem]"],[3,"value"],["value",""],["type","text","formControlName","name",1,"w-0","flex-1",3,"focus","blur"],[1,"m-1","text-sm","text-red-light"]]},template:function(e,i){e&1&&(l(0,"form",2)(1,"select",3),V(2,Mt,2,2,"option",4,We),l(4,"option",5),b(5,"+"),a()(),l(6,"input",6),d("focus",function(r){return i.focus(r)})("blur",function(){return i.blur()}),a()(),m(7,qt,2,1,"div",7)),e&2&&(c("formGroup",i.form),_(2),L(i.categories()),_(5),u(i.mode()==="edit"&&i.form.valid===!1&&i.form.touched?7:-1))},dependencies:[Oe,Re,mt,pt,j,ct,Y,Te,be,Se],encapsulation:2,changeDetection:0})};var Ft=(n,t,e)=>({"font-bold":n,"text-green-light":t,"text-red-light":e});function Dt(n,t){n&1&&(l(0,"span"),g(1,0),a()),n&2&&(_(),$(t),q(1))}function Qt(n,t){n&1&&(l(0,"span"),g(1,1),a())}function Ut(n,t){n&1&&(l(0,"span"),g(1,2),a())}function Gt(n,t){if(n&1&&(l(0,"span"),g(1,3),a()),n&2){let e=s();_(),$(e),q(1)}}function kt(n,t){n&1&&m(0,Ut,2,0,"span")(1,Gt,2,1,"span"),n&2&&u(t===" "?0:1)}function zt(n,t){n&1&&(l(0,"span"),g(1,4),a())}function Xt(n,t){n&1&&(l(0,"span"),g(1,5),a())}function Bt(n,t){n&1&&(l(0,"span"),g(1,6),a())}function Wt(n,t){if(n&1&&(l(0,"div",12),m(1,Dt,2,1,"span")(2,Qt,2,0,"span")(3,kt,2,1)(4,zt,2,0,"span")(5,Xt,2,0,"span")(6,Bt,2,0,"span"),a()),n&2){let e,i,o=s();_(),u((e=o.form.controls.question.errors==null?null:o.form.controls.question.errors.pattern)?1:-1,e),_(),u(o.form.controls.question.errors!=null&&o.form.controls.question.errors.required?2:-1),_(),u((i=o.form.controls.variable.errors==null?null:o.form.controls.variable.errors.pattern)?3:-1,i),_(),u(o.form.controls.variable.errors!=null&&o.form.controls.variable.errors.required?4:-1),_(),u(o.form.controls.variable.errors!=null&&o.form.controls.variable.errors.reserved?5:-1),_(),u(o.form.controls.variable.errors!=null&&o.form.controls.variable.errors.used?6:-1)}}var Ne=class n{question=N.required();parser=p(Q);state=p(v);variables=this.state.signal("variables");mode=this.state.signal("rulesMode");highlighVariable=R(()=>this.mode()!=="edit"&&this.state.signal("highlightVariableStatus")());variableActive=R(()=>this.state.signal("activeAnswers")()[this.question().variable]);refactorVariables=this.state.signal("refactorVariables");questionChanged=x();variableChanged=x();fb=p(ve).nonNullable;form=this.fb.group({question:this.fb.control("",{validators:[this.validateQuestionPattern(),re.required.bind(this)]}),variable:this.fb.control("",{validators:[this.validateVariablePattern(),jt(),re.required.bind(this)],asyncValidators:[Yt($e(this.variables),$e(this.question))]})});constructor(){w(()=>{this.question(),this.reset()});let t=ge(this.form.valueChanges.pipe(ue(500),_e(()=>this.form.valid)));w(()=>{let e=t();e?.question&&e.question!==this.question().question&&e.variable?this.questionChanged.emit(new P(e.question,e.variable)):e?.variable&&e.variable.trim()!==this.question().variable&&(this.question().variable===P.NEW_VARIABLE_NAME||!this.refactorVariables()?this.questionChanged.emit(new P(this.question().question,e.variable.trim())):this.variableChanged.emit([this.question().variable,e.variable.trim()]))}),w(()=>{this.mode()==="edit"?this.form.enable({emitEvent:!1}):this.form.disable({emitEvent:!1}),this.reset()})}reset(){this.form.patchValue(this.question(),{emitEvent:!1})}focusQuestion(){this.form.controls.question.value===P.NEW_QUESTION_NAME&&this.form.controls.question.setValue("",{emitEvent:!1})}focusVariable(){this.form.controls.variable.value===P.NEW_VARIABLE_NAME&&this.form.controls.variable.setValue("",{emitEvent:!1})}validateVariablePattern(){return t=>{let e=t.value?.trim()??"";try{return this.parser.validateVariableName(e),null}catch(i){return t.markAsTouched(),i instanceof W?{pattern:i.found}:{pattern:!0}}}}validateQuestionPattern(){return t=>{let e=t.value?.trim()??"";try{return this.parser.validateQuestionString(e),null}catch(i){return t.markAsTouched(),i instanceof W?{pattern:i.found}:{pattern:!0}}}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=O({type:n,selectors:[["app-editor-question"]],inputs:{question:[1,"question"]},outputs:{questionChanged:"questionChanged",variableChanged:"variableChanged"},decls:6,vars:7,consts:()=>{let t;t=$localize`:@@edit.question.question.placeholder:question`;let e;e=$localize`:@@edit.question.variable.placeholder:variable`;let i;i=$localize`:@@edit.question.question.invalid-character:Questions cannot contain this character: '${"\uFFFD0\uFFFD"}:INTERPOLATION:'`;let o;o=$localize`:@@edit.question.question.required:Question is required`;let r;r=$localize`:@@edit.question.variable.invalid-spaces:Variables cannot contain spaces`;let T;T=$localize`:@@edit.question.variable.invalid-character:Variables cannot contain this character: '${"\uFFFD0\uFFFD"}:INTERPOLATION:'`;let I;I=$localize`:@@edit.question.variable.required:Variable name is required`;let Z;Z=$localize`:@@edit.question.variable.reserved:This variable name is reserved`;let le;return le=$localize`:@@edit.question.variable.used:This variable name is already used`,[i,o,r,T,I,Z,le,[1,"flex","flex-col",3,"formGroup"],["type","text","placeholder",t,"formControlName","question",1,"grow",3,"focus"],[1,"flex","items-center","gap-2"],[1,"ml-2","h-4"],["type","text","placeholder",e,"formControlName","variable",1,"grow","font-mono",3,"focus","ngClass"],[1,"m-1","flex","flex-col","text-sm","text-red-light"]]},template:function(e,i){e&1&&(l(0,"form",7)(1,"input",8),d("focus",function(){return i.focusQuestion()}),a(),l(2,"div",9),E(3,"app-icon-arrow-forward",10),l(4,"input",11),d("focus",function(){return i.focusVariable()}),a()(),m(5,Wt,7,6,"div",12),a()),e&2&&(c("formGroup",i.form),_(4),c("ngClass",B(3,Ft,i.highlighVariable(),i.highlighVariable()&&i.variableActive(),i.highlighVariable()&&!i.variableActive())),_(),u(i.mode()==="edit"&&i.form.valid===!1&&i.form.touched?5:-1))},dependencies:[Oe,Re,j,Y,Te,be,Se,D,it],encapsulation:2,changeDetection:0})};function jt(){return n=>[ie.string,qe,Fe,De,Qe].some(t=>t===n.value?.trim())?{reserved:!0}:null}function Yt(n,t){return e=>se(e.value).pipe(ze(n.pipe(ye(i=>[...i])),t),ke(([i,o,r])=>Ge(()=>!o.find(T=>T===r.variable),se(null),se([i,o,r]).pipe(ye(([T,I,Z])=>{let le=I.findIndex(A=>A===Z.variable);return I.splice(le,1),I.includes(T?.trim()??"")?{used:!0}:null})))))}var H=class n{serializer=p(M);parser=p(Q);state=p(v);questions=this.state.signal("clipboardQuestions");items=this.state.signal("clipboardItems");itemsCount=R(()=>this.items().length);questionsCount=R(()=>this.questions().length);cutQuestion(t){this.questions.update(e=>[...e,this.serializer.serialize(t)])}cutItem(t){this.items.update(e=>[...e,this.serializer.serialize(t)])}paste(){let t={questions:this.questions().map(e=>this.parser.parseQuestion(e)),items:this.items().map(e=>this.parser.parseItem(e))};return this.questions.set([]),this.items.set([]),t}static \u0275fac=function(e){return new(e||n)};static \u0275prov=Xe({token:n,factory:n.\u0275fac,providedIn:"root"})};function Kt(n,t){if(n&1){let e=h();l(0,"button",7),d("click",function(){C(e);let o=s();return f(o.resetCondition())}),E(1,"app-icon-clear"),a()}}function Ht(n,t){if(n&1){let e=h();l(0,"button",11),d("click",function(){C(e);let o=s(2).$index,r=s();return f(r.swapQuestions(o,o+1))}),E(1,"app-icon-arrow-downward"),a()}}function Jt(n,t){n&1&&E(0,"span",10)}function Zt(n,t){if(n&1&&m(0,Ht,2,0,"button",9)(1,Jt,1,0,"span",10),n&2){let e=s().$index,i=s();u(e<i.rule().questions.length-1?0:1)}}function ei(n,t){if(n&1){let e=h();l(0,"button",7),d("click",function(){C(e);let o=s().$index,r=s();return f(r.deleteQuestion(o))}),E(1,"app-icon-delete"),a()}}function ti(n,t){if(n&1){let e=h();l(0,"button",7),d("click",function(){C(e);let o=s().$index,r=s();return f(r.cutQuestion(o))}),E(1,"app-icon-cut"),a()}}function ii(n,t){if(n&1){let e=h();l(0,"button",11),d("click",function(){C(e);let o=s().$index,r=s();return f(r.swapQuestions(o-1,o))}),E(1,"app-icon-arrow-upward"),a()}}function ni(n,t){if(n&1){let e=h();l(0,"div",2),m(1,Zt,2,1),l(2,"app-editor-question",8),d("questionChanged",function(o){let r=C(e).$index,T=s();return f(T.updateQuestion(r,o))})("variableChanged",function(o){C(e);let r=s();return f(r.variableChanged(o))}),a(),m(3,ei,2,0,"button",4)(4,ti,2,0,"button",4)(5,ii,2,0,"button",9),a()}if(n&2){let e=t.$implicit,i=t.$index,o=s();_(),u(o.mode()==="swap"&&o.rule().questions.length>1?1:-1),_(),c("question",e),_(),u(o.mode()==="delete"?3:o.mode()==="cut-paste"?4:o.mode()==="swap"&&i>0?5:-1)}}function oi(n,t){if(n&1){let e=h();l(0,"button",11),d("click",function(){C(e);let o=s(2).$index,r=s();return f(r.swapItems(o,o+1))}),E(1,"app-icon-arrow-downward"),a()}}function ri(n,t){n&1&&E(0,"span",10)}function ai(n,t){if(n&1&&m(0,oi,2,0,"button",9)(1,ri,1,0,"span",10),n&2){let e=s().$index,i=s();u(e<i.rule().items.length-1?0:1)}}function li(n,t){if(n&1){let e=h();l(0,"button",7),d("click",function(){C(e);let o=s().$index,r=s();return f(r.deleteItem(o))}),E(1,"app-icon-delete"),a()}}function si(n,t){if(n&1){let e=h();l(0,"button",7),d("click",function(){C(e);let o=s().$index,r=s();return f(r.cutItem(o))}),E(1,"app-icon-cut"),a()}}function _i(n,t){if(n&1){let e=h();l(0,"button",11),d("click",function(){C(e);let o=s().$index,r=s();return f(r.swapItems(o-1,o))}),E(1,"app-icon-arrow-upward"),a()}}function ui(n,t){if(n&1){let e=h();l(0,"div",2),m(1,ai,2,1),l(2,"app-editor-item",12),d("itemChanged",function(o){let r=C(e).$index,T=s();return f(T.updateItem(r,o))}),a(),m(3,li,2,0,"button",4)(4,si,2,0,"button",4)(5,_i,2,0,"button",9),a()}if(n&2){let e=t.$implicit,i=t.$index,o=s();_(),u(o.mode()==="swap"&&o.rule().items.length>1?1:-1),_(),c("item",e),_(),u(o.mode()==="delete"?3:o.mode()==="cut-paste"?4:o.mode()==="swap"&&i>0?5:-1)}}function di(n,t){if(n&1){let e=h();l(0,"div",5)(1,"button",13),d("click",function(){C(e);let o=s();return f(o.addQuestion())}),g(2,0),a(),l(3,"button",13),d("click",function(){C(e);let o=s();return f(o.addItem())}),g(4,1),a()()}}function ci(n,t){if(n&1){let e=h();l(0,"button",7),d("click",function(){C(e);let o=s(2);return f(o.deleteRule.emit())}),E(1,"app-icon-delete"),a()}}function mi(n,t){if(n&1){let e=h();l(0,"button",7),d("click",function(){C(e);let o=s(2);return f(o.paste())}),E(1,"app-icon-paste"),a()}}function pi(n,t){if(n&1&&(l(0,"div",6),m(1,ci,2,0,"button",4)(2,mi,2,0,"button",4),a()),n&2){let e=s();_(),u(e.mode()==="delete"?1:-1),_(),u(e.mode()==="cut-paste"?2:-1)}}function Ci(n,t){if(n&1&&(l(0,"pre"),b(1),a(),l(2,"pre"),b(3),a()),n&2){let e=s();_(),F(t),_(2),F(e.ruleDebugString())}}var Ae=class n{rule=N.required();ruleChanged=x();deleteRule=x();renameVariable=x();ruleDebugString=R(()=>this.serializer.serialize(this.rule()));errorMessage=de(null);state=p(v);mode=this.state.signal("rulesMode");selectVariables=R(()=>{let t=this.rule().questions.map(i=>i.variable);return this.state.get("variables").filter(i=>!t.includes(i))});clipboard=p(H);parser=p(Q);serializer=p(M);compileRule(t){try{return this.parser.parseRule(this.serializer.serialize(t)),this.errorMessage.set(null),!0}catch(e){return e instanceof Error&&this.errorMessage.set(e.message),!1}}resetCondition(){this.updateCondition(new y)}updateCondition(t){let e=new z(t,this.rule().questions,this.rule().items);this.compileRule(e)&&this.ruleChanged.emit(e)}emitNewQuestions(t){let e=new z(this.rule().condition,t,this.rule().items);this.compileRule(e)&&this.ruleChanged.emit(e)}updateQuestion(t,e){let i=this.rule().questions;i[t]=e,this.emitNewQuestions(i)}addQuestion(){let t=new P(P.NEW_QUESTION_NAME,P.NEW_VARIABLE_NAME);this.updateQuestion(this.rule().questions.length,t)}deleteQuestion(t){let e=this.rule().questions;e.splice(t,1),this.emitNewQuestions(e)}cutQuestion(t){let e=this.rule().questions[t];this.deleteQuestion(t),this.clipboard.cutQuestion(e)}swapQuestions(t,e){let i=this.rule().questions,o=i[t];i[t]=i[e],i[e]=o,this.emitNewQuestions(i)}emitNewItems(t){let e=new z(this.rule().condition,this.rule().questions,t);this.compileRule(e)&&this.ruleChanged.emit(e)}updateItem(t,e){let i=this.rule().items;i[t]=e,this.emitNewItems(i)}addItem(){let t=new X(X.NEW_CATEGORY_NAME,X.NEW_ITEM_NAME);this.updateItem(this.rule().items.length,t)}deleteItem(t){let e=this.rule().items;e.splice(t,1),this.emitNewItems(e)}cutItem(t){let e=this.rule().items[t];this.deleteItem(t),this.clipboard.cutItem(e)}swapItems(t,e){let i=this.rule().items,o=i[t];i[t]=i[e],i[e]=o,this.emitNewItems(i)}paste(){let{questions:t,items:e}=this.clipboard.paste(),i=new z(this.rule().condition,[...this.rule().questions,...t],[...this.rule().items,...e]);this.ruleChanged.emit(i)}variableChanged([t,e]){this.renameVariable.emit([t,e])}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=O({type:n,selectors:[["app-editor-rule"]],inputs:{rule:[1,"rule"]},outputs:{ruleChanged:"ruleChanged",deleteRule:"deleteRule",renameVariable:"renameVariable"},decls:10,vars:5,consts:()=>{let t;t=$localize`:@@edit.rules.add-question: + Question `;let e;return e=$localize`:@@edit.rules.add-item: + Item `,[t,e,[1,"mb-1","flex","items-center"],[1,"grow",3,"conditionChanged","condition","selectVariables"],["type","button",1,"link"],[1,"flex","justify-end","gap-2"],[1,"flex","justify-center"],["type","button",1,"link",3,"click"],[1,"grow",3,"questionChanged","variableChanged","question"],["type","button",1,"link","p-1"],[1,"ml-6"],["type","button",1,"link","p-1",3,"click"],[1,"grow",3,"itemChanged","item"],["type","button",1,"h-8",3,"click"]]},template:function(e,i){if(e&1&&(l(0,"div",2)(1,"app-editor-condition",3),d("conditionChanged",function(r){return i.updateCondition(r)}),a(),m(2,Kt,2,0,"button",4),a(),V(3,ni,6,3,"div",2,ee),V(5,ui,6,3,"div",2,ee),m(7,di,5,0,"div",5)(8,pi,3,2,"div",6)(9,Ci,4,2)),e&2){let o;_(),c("condition",i.rule().condition)("selectVariables",i.selectVariables()),_(),u(i.mode()==="edit"?2:-1),_(),L(i.rule().questions),_(2),L(i.rule().items),_(2),u(i.mode()==="edit"?7:8),_(2),u((o=i.errorMessage())?9:-1,o)}},dependencies:[Ie,Ne,xe,Ce,ot,at,pe,tt,nt],encapsulation:2,changeDetection:0})};var fi=["searchInput"],Ei=n=>({"sticky left-0 top-0 z-30 shadow-md":n}),J=n=>({active:n}),we=n=>({"fill-slate-400":n});function hi(n,t){n&1&&(l(0,"span"),g(1,2),a())}function gi(n,t){if(n&1&&(l(0,"span"),g(1,3),a()),n&2){let e=t;_(),$(e)(e),q(1)}}function Ti(n,t){if(n&1&&(l(0,"span"),g(1,4),a()),n&2){let e=t;_(),$(e)(e),q(1)}}function Ri(n,t){if(n&1&&m(0,gi,2,2,"span")(1,Ti,2,2,"span"),n&2){let e,i,o=s(2);u((e=o.clipboard.itemsCount())?0:-1,e),_(),u((i=o.clipboard.questionsCount())?1:-1,i)}}function bi(n,t){if(n&1&&(l(0,"div",11)(1,"span"),g(2,1),a(),m(3,hi,2,0,"span")(4,Ri,2,2),a()),n&2){let e=s();_(3),u(e.clipboard.itemsCount()===0&&e.clipboard.questionsCount()===0?3:4)}}function Si(n,t){if(n&1){let e=h();l(0,"div",12)(1,"input",13,0),Je("ngModelChange",function(o){C(e);let r=s();return He(r.searchTerm,o)||(r.searchTerm=o),f(o)}),a(),l(3,"button",14),d("click",function(){C(e);let o=s();return f(o.clearSearch())}),E(4,"app-icon-clear",15),a()()}if(n&2){let e=s();_(),Ke("ngModel",e.searchTerm)}}var Pe=class n{noOfVisibleRules=N.required();state=p(v);mode=this.state.signal("rulesMode");searchTerm=this.state.signal("filterRulesQuery");clipboard=p(H);sticky=R(()=>this.state.signal("scrollY")()>48);searchInput=G.required("searchInput");focusSearch(){setTimeout(()=>{this.searchInput().nativeElement.focus()},50)}clearSearch(){this.searchTerm.set(""),this.focusSearch()}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=O({type:n,selectors:[["app-toolbar"]],viewQuery:function(e,i){e&1&&k(i.searchInput,fi,5),e&2&&ce()},inputs:{noOfVisibleRules:[1,"noOfVisibleRules"]},decls:16,vars:38,consts:()=>{let t;t=$localize`:@@edit.toolbar.clipboard:Clipboard:`;let e;e=$localize`:@@edit.toolbar.clipboard.empty:empty`;let i;i=$localize`:@@edit.toolbar.clipboard.items:{VAR_PLURAL, plural, one {1 Item} other {{INTERPOLATION} Items}}`,i=Ve(i,{INTERPOLATION:"\uFFFD1\uFFFD",VAR_PLURAL:"\uFFFD0\uFFFD"});let o;return o=$localize`:@@edit.toolbar.clipboard.questions:{VAR_PLURAL, plural, one {1 Question} other {{INTERPOLATION} Questions}}`,o=Ve(o,{INTERPOLATION:"\uFFFD1\uFFFD",VAR_PLURAL:"\uFFFD0\uFFFD"}),[["searchInput",""],t,e,i,o,[1,"bg-active","py-2",3,"ngClass"],[1,"mb-1","grid","grid-cols-6","gap-2"],["type","button",1,"link",3,"click","ngClass"],[1,"my-auto","h-6","w-6"],["type","button",1,"link",3,"click","ngClass","disabled"],[1,"my-auto","h-6","w-6",3,"ngClass"],[1,"mt-2","flex","justify-center","gap-4"],[1,"mt-2","flex","items-center"],["type","text",1,"grow",3,"ngModelChange","ngModel"],["type","button",1,"link",3,"click"],[1,"h-6","w-6"]]},template:function(e,i){e&1&&(l(0,"div",5)(1,"div",6)(2,"button",7),d("click",function(){return i.mode.set("view")}),E(3,"app-icon-view",8),a(),l(4,"button",9),d("click",function(){return i.mode.set("edit")}),E(5,"app-icon-edit",10),a(),l(6,"button",9),d("click",function(){return i.mode.set("delete")}),E(7,"app-icon-delete",10),a(),l(8,"button",9),d("click",function(){return i.mode.set("cut-paste")}),E(9,"app-icon-reorder",10),a(),l(10,"button",9),d("click",function(){return i.mode.set("swap")}),E(11,"app-icon-swap",10),a(),l(12,"button",7),d("click",function(){return i.mode.set("search"),i.focusSearch()}),E(13,"app-icon-search",8),a()(),m(14,bi,5,1,"div",11)(15,Si,5,1,"div",12),a()),e&2&&(c("ngClass",S(16,Ei,i.sticky())),_(2),c("ngClass",S(18,J,i.mode()==="view")),_(2),c("ngClass",S(20,J,i.mode()==="edit"))("disabled",!i.noOfVisibleRules()&&!!i.searchTerm()),_(),c("ngClass",S(22,we,!i.noOfVisibleRules()&&!!i.searchTerm())),_(),c("ngClass",S(24,J,i.mode()==="delete"))("disabled",!i.noOfVisibleRules()),_(),c("ngClass",S(26,we,!i.noOfVisibleRules())),_(),c("ngClass",S(28,J,i.mode()==="cut-paste"))("disabled",i.noOfVisibleRules()<2),_(),c("ngClass",S(30,we,i.noOfVisibleRules()<2)),_(),c("ngClass",S(32,J,i.mode()==="swap"))("disabled",!i.noOfVisibleRules()),_(),c("ngClass",S(34,we,!i.noOfVisibleRules())),_(),c("ngClass",S(36,J,i.mode()==="search")),_(2),u(i.mode()==="cut-paste"?14:i.mode()==="search"||i.searchTerm()?15:-1))},dependencies:[Ct,j,Y,dt,D,_t,rt,Ce,lt,fe,st,pe],encapsulation:2,changeDetection:0})};var vi=(n,t)=>t.index,Oi=(n,t,e)=>({disabled:n,"animate-pulse":t,"mb-[2.25rem]":e});function Ii(n,t){if(n&1){let e=h();l(0,"div",4)(1,"button",7),d("click",function(){C(e);let o=s().$implicit,r=s();return f(r.swapRules(o.index-1,o.index))}),E(2,"app-icon-swap"),a()()}}function xi(n,t){if(n&1){let e=h();m(0,Ii,3,0,"div",4),l(1,"div",5)(2,"app-editor-rule",6),d("ruleChanged",function(o){let r=C(e).$implicit,T=s();return f(T.updateRule(r.index,o))})("deleteRule",function(){let o=C(e).$implicit,r=s();return f(r.deleteRule(o.index))})("renameVariable",function(o){C(e);let r=s();return f(r.renameVariable(o))}),a()()}if(n&2){let e=t.$implicit,i=s();u(e.index>0&&i.mode()==="swap"&&!i.filter()?0:-1),_(),c("id","rule-"+e.index)("ngClass",B(4,Oi,i.showAsDisabled(e.rule),i.highlightRule()===e.index,i.mode()==="view"||i.mode()==="search")),_(),c("rule",e.rule)}}function Ni(n,t){if(n&1){let e=h();l(0,"button",8),d("click",function(){C(e);let o=s();return f(o.addRule())}),g(1,0),a()}}function Ai(n,t){n&1&&(l(0,"a",3),E(1,"img",9),a())}var Ue=class n{serializer=p(M);refactor=p(ut);state=p(v);parsedRules=this.state.signal("parsedRules");activeRules=this.state.signal("activeRules");mode=this.state.signal("rulesMode");filter=this.state.signal("filterRulesQuery");highlightRule=de(void 0);visibleRules=R(()=>this.filter()===""?this.parsedRules().map((e,i)=>({rule:e,index:i})):this.parsedRules().map((e,i)=>({rule:e,index:i})).filter(e=>{let i=this.filter();return!i||this.refactor.contains(e.rule,i)}));goToPacklistButtonVisible=R(()=>this.state.signal("scrollY")()>100);updateRules(t){let e=this.serializer.serializeRules(t);this.state.set("rules",e)}updateRule(t,e){let i=this.parsedRules();i[t]=e,this.updateRules([...i])}deleteRule(t){let e=this.parsedRules();e.splice(t,1),this.updateRules([...e])}addRule(){let t=this.parsedRules().length,e=[];for(let r=0;r<this.parsedRules().length;r++){let T=document.querySelector(`#rule-${r.toString()}`);if(T){let I=T.getBoundingClientRect();I.top>=0&&I.bottom<=window.innerHeight&&e.push(r)}}e.includes(t-1)||(t=e[0]+1);let i=new z(new y),o=this.parsedRules();o.splice(t,0,i),this.updateRules([...o]),this.highlightRule.set(t),setTimeout(()=>{this.highlightRule.set(void 0)},4e3)}swapRules(t,e){let i=this.parsedRules(),o=i[t];i[t]=i[e],i[e]=o,this.updateRules([...i])}showAsDisabled(t){return this.state.get("fadeOutDisabledRules")&&!this.activeRules().includes(t)}renameVariable([t,e]){let i=this.refactor.renameVariable(t,e,this.parsedRules());this.updateRules(i)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=O({type:n,selectors:[["app-rules"]],decls:5,vars:3,consts:()=>{let t;t=$localize`:@@edit.rules.add-rule: + Rule `;let e;return e=$localize`:@@app.icon:application icon`,[t,[3,"noOfVisibleRules"],["type","button",1,"fixed","bottom-2","z-50"],["routerLink","/packlist",1,"fixed","bottom-2","right-2","z-50"],[1,"flex","justify-center"],[1,"card","mb-1",3,"id","ngClass"],[3,"ruleChanged","deleteRule","renameVariable","rule"],["type","button",1,"link",3,"click"],["type","button",1,"fixed","bottom-2","z-50",3,"click"],["alt",e,"src","icon.svg",1,"h-12"]]},template:function(e,i){e&1&&(E(0,"app-toolbar",1),V(1,xi,3,8,null,null,vi),m(3,Ni,2,0,"button",2)(4,Ai,2,0,"a",3)),e&2&&(c("noOfVisibleRules",i.visibleRules().length),_(),L(i.visibleRules()),_(2),u(i.mode()==="edit"&&!i.filter()?3:-1),_(),u(i.goToPacklistButtonVisible()?4:-1))},dependencies:[Ae,Pe,fe,D,Ze],encapsulation:2,changeDetection:0})};export{Ue as default};
