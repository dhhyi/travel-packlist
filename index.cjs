"use strict";var ls=Object.defineProperty;var as=Object.getOwnPropertyDescriptor;var ae=(o,i,e,f)=>{for(var p=f>1?void 0:f?as(i,e):i,h=o.length-1,w;h>=0;h--)(w=o[h])&&(p=(f?w(i,e,p):w(p))||p);return f&&p&&ls(i,e,p),p};var _=class{constructor(i,e=[],f=[]){this.condition=i;this.questions=e;this.items=f}},P=class{constructor(i,e){this.question=i;this.variable=e}static NEW_QUESTION_NAME="New Question";static NEW_VARIABLE_NAME="new_variable"};function Je(o){return o?o.trim().replace(/[^\w]/g,"_").replace(/__+/g,"_").replace(/^_+/,"").replace(/_+$/,""):""}var q=class{constructor(i,e,f){this.category=i;this.name=e;this.weight=f}static NEW_ITEM_NAME="New Item";static NEW_CATEGORY_NAME="New";id(){return`${Je(this.category)}-${Je(this.name)}`}},C=class{constructor(i){this.variable=i}evaluate(i){return i[this.variable]}},Z=class o extends C{static string="please_select";constructor(){super(o.string)}},N=class o extends C{static string="always";constructor(){super(o.string)}evaluate(){return!0}},V=class{constructor(i){this.not=i}evaluate(i){return!this.not.evaluate(i)}},S=class{constructor(i,e){this.left=i;this.right=e}evaluate(i){return this.left.evaluate(i)&&this.right.evaluate(i)}},I=class{constructor(i,e){this.left=i;this.right=e}evaluate(i){return this.left.evaluate(i)||this.right.evaluate(i)}};function cs(o,i){let e=i.filter(p=>p instanceof P),f=i.filter(p=>p instanceof q);return new _(o??new N,e,f)}function et(o){return o.length===1?o[0]:new S(o[0],et(o.slice(1)))}function tt(o){return o.length===1?o[0]:new I(o[0],tt(o.slice(1)))}var Q=class extends SyntaxError{constructor(i,e,f,p){super(i),this.expected=e,this.found=f,this.location=p,this.name="SyntaxError"}format(i){let e="Error: "+this.message;if(this.location){let f=null,p=i.find(T=>T.source===this.location.source);p&&(f=p.text.split(/\r\n|\n|\r/g));let h=this.location.start,w=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(h):h,O=this.location.source+":"+w.line+":"+w.column;if(f){let T=this.location.end,D="".padEnd(w.line.toString().length," "),z=f[h.line-1],b=(h.line===T.line?T.column:z.length+1)-h.column||1;e+=`
 --> `+O+`
`+D+` |
`+w.line+" | "+z+`
`+D+" | "+"".padEnd(h.column-1," ")+"".padEnd(b,"^")}else e+=`
 at `+O}return e}static buildMessage(i,e){function f(b){return b.codePointAt(0).toString(16).toUpperCase()}let p=Object.prototype.hasOwnProperty.call(RegExp.prototype,"unicode")?new RegExp("[\\p{C}\\p{Mn}\\p{Mc}]","gu"):null;function h(b){return p?b.replace(p,m=>"\\u{"+f(m)+"}"):b}function w(b){return h(b.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,m=>"\\x0"+f(m)).replace(/[\x10-\x1F\x7F-\x9F]/g,m=>"\\x"+f(m)))}function O(b){return h(b.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,m=>"\\x0"+f(m)).replace(/[\x10-\x1F\x7F-\x9F]/g,m=>"\\x"+f(m)))}let T={literal(b){return'"'+w(b.text)+'"'},class(b){let m=b.parts.map(F=>Array.isArray(F)?O(F[0])+"-"+O(F[1]):O(F));return"["+(b.inverted?"^":"")+m.join("")+"]"+(b.unicode?"u":"")},any(){return"any character"},end(){return"end of input"},other(b){return b.description}};function D(b){return T[b.type](b)}function z(b){let m=b.map(D);if(m.sort(),m.length>0){let F=1;for(let L=1;L<m.length;L++)m[L-1]!==m[L]&&(m[F]=m[L],F++);m.length=F}switch(m.length){case 1:return m[0];case 2:return m[0]+" or "+m[1];default:return m.slice(0,-1).join(", ")+", or "+m[m.length-1]}}function k(b){return b?'"'+w(b)+'"':"end of input"}return"Expected "+z(i)+" but "+k(e)+" found."}};function E(o,i){i=i!==void 0?i:{};let e={},f=i.grammarSource,p={Rules:Qe,Rule:he,Condition:De,Effects:qe,Question:me,Item:be,VariableName:$e,QuestionString:Me,ItemNameAndWeight:Ge,CategoryName:Ue},h=Qe,w="#",O=";",T=":-",D="OR",z="AND",k="NOT",b=",",m="$",F="[",L="]",Re="kg",lt="g",at=".",ee=/^[^\n\r]/,Ae=/^[^$,;#]/,ct=/^[a-zA-Z]/,Ce=/^[a-zA-Z0-9\-[\](){}_]/,Ee=/^[^\],;#[]/,ft=/^[,;]/,ve=/^[^ ,;#]/,te=/^[0-9]/,Ve=/^[ \t\n\r]/,ut=R("title"),Se=A("#",!1),se=W([`
`,"\r"],!0,!1,!1),gt=R("comment"),pt=R("rule end"),ht=A(";",!1),dt=R("rule"),mt=A(":-",!1),re=R("condition"),$t=A("OR",!1),bt=A("AND",!1),pe=A("NOT",!1),wt=A(",",!1),Ie=R("question"),xt=A("$",!1),Fe=W(["$",",",";","#"],!0,!1,!1),yt=R("variable name"),Rt=W([["a","z"],["A","Z"]],!1,!1,!1),Ne=W([["a","z"],["A","Z"],["0","9"],"-","[","]","(",")","{","}","_"],!1,!1,!1),At=R("item"),Ct=R("category"),Et=A("[",!1),vt=A("]",!1),Vt=R("category name"),Oe=W(["]",",",";","#","["],!0,!1,!1),St=R("item name"),It=R("word"),Ft=W([",",";"],!1,!1,!1),Te=W([" ",",",";","#"],!0,!1,!1),Nt=R("weight"),Ot=A("kg",!1),Tt=A("g",!1),kt=R("number"),ne=W([["0","9"]],!1,!1,!1),Wt=A(".",!1),ke=W([" ","	",`
`,"\r"],!1,!1,!1),Pt=ts();function _t(t,s,n){return s.title=t?.trim(),s.rulesContainComments=Xe,s.warnings=n,s}function Qt(t){if(t.trim().length)return t.trim()}function jt(t){if(t.trim().length)return Xe=!0,t.trim()}function Dt(t,s){return cs(t,s)}function zt(t){return tt(t)}function Lt(t){return et(t)}function qt(t){return new V(t)}function Mt(t){return xe.add(t),new C(t)}function Ut(t,s){return oe.has(s)&&le.push({variable:s,type:"duplicate"}),oe.add(s),new P(t.trim(),s)}function Gt(t,s){let{name:n,weight:l}=s;return new q(t.trim(),n,l)}function Ht(t,s){return i.trackWeight}function Zt(t,s){let n=t.trim();return n.length||We("item name"),{name:n,weight:s}}function Bt(t){let s=t.trim();return s.length||We("item name"),{name:s,weight:void 0}}function Kt(t){return t*1e3}function Xt(){return parseFloat(Jt())}function Yt(){for(let t of xe)t!==Z.string&&t!==N.string&&!oe.has(t)&&le.push({variable:t,type:"undeclared"});for(let t of oe)xe.has(t)||le.push({variable:t,type:"unused"});return le}let r=i.peg$currPos|0,x=r,U=[{line:1,column:1}],v=r,ie=i.peg$maxFailExpected||[],a=i.peg$silentFails|0,K;if(i.startRule){if(!(i.startRule in p))throw new Error(`Can't start parsing from rule "`+i.startRule+'".');h=p[i.startRule]}function Jt(){return o.substring(x,r)}function xs(){return x}function ys(){return{source:f,start:x,end:r}}function Rs(){return X(x,r)}function We(t,s){throw s=s!==void 0?s:X(x,r),_e([R(t)],o.substring(x,r),s)}function As(t,s){throw s=s!==void 0?s:X(x,r),rs(t,s)}function es(t=r){let s=o.codePointAt(t);return s===void 0?"":String.fromCodePoint(s)}function A(t,s){return{type:"literal",text:t,ignoreCase:s}}function W(t,s,n,l){return{type:"class",parts:t,inverted:s,ignoreCase:n,unicode:l}}function ts(){return{type:"any"}}function ss(){return{type:"end"}}function R(t){return{type:"other",description:t}}function Pe(t){let s=U[t],n;if(s)return s;if(t>=U.length)n=U.length-1;else for(n=t;!U[--n];);for(s=U[n],s={line:s.line,column:s.column};n<t;)o.charCodeAt(n)===10?(s.line++,s.column=1):s.column++,n++;return U[t]=s,s}function X(t,s,n){let l=Pe(t),c=Pe(s),u={source:f,start:{offset:t,line:l.line,column:l.column},end:{offset:s,line:c.line,column:c.column}};return n&&f&&typeof f.offset=="function"&&(u.start=f.offset(u.start),u.end=f.offset(u.end)),u}function g(t){r<v||(r>v&&(v=r,ie=[]),ie.push(t))}function rs(t,s){return new Q(t,null,null,s)}function _e(t,s,n){return new Q(Q.buildMessage(t,s),t,s,n)}function Qe(){let t,s,n,l,c,u,d,y;for(t=r,s=$(),n=ns(),n===e&&(n=null),l=$(),c=[],u=he();u!==e;)c.push(u),u=r,d=je(),d!==e?(d=he(),d===e?(r=u,u=e):u=d):u=d;return u=je(),u===e&&(u=null),d=$(),y=Ke(),y!==e?(x=t,t=_t(n,c,y)):(r=t,t=e),t}function ns(){let t,s,n,l,c,u;if(a++,t=r,o.charCodeAt(r)===35?(s=w,r++):(s=e,a===0&&g(Se)),s!==e){if(n=$(),l=r,c=[],u=o.charAt(r),ee.test(u)?r++:(u=e,a===0&&g(se)),u!==e)for(;u!==e;)c.push(u),u=o.charAt(r),ee.test(u)?r++:(u=e,a===0&&g(se));else c=e;c!==e?l=o.substring(l,r):l=c,l!==e?(c=$(),x=t,t=Qt(l)):(r=t,t=e)}else r=t,t=e;return a--,t===e&&(s=e,a===0&&g(ut)),t}function G(){let t,s,n,l,c;if(a++,t=r,o.charCodeAt(r)===35?(s=w,r++):(s=e,a===0&&g(Se)),s!==e){if(n=r,l=[],c=o.charAt(r),ee.test(c)?r++:(c=e,a===0&&g(se)),c!==e)for(;c!==e;)l.push(c),c=o.charAt(r),ee.test(c)?r++:(c=e,a===0&&g(se));else l=e;l!==e?n=o.substring(n,r):n=l,n!==e?(l=$(),x=t,t=jt(n)):(r=t,t=e)}else r=t,t=e;return a--,t===e&&(s=e,a===0&&g(gt)),t}function je(){let t,s,n,l,c,u;if(a++,t=r,s=$(),o.charCodeAt(r)===59?(n=O,r++):(n=e,a===0&&g(ht)),n!==e){for(l=$(),c=[],u=G();u!==e;)c.push(u),u=G();u=$(),s=[s,n,l,c,u],t=s}else r=t,t=e;return a--,t===e&&(s=e,a===0&&g(pt)),t}function he(){let t,s,n,l,c,u,d,y;for(a++,t=r,s=[],n=G();n!==e;)s.push(n),n=G();return n=$(),l=De(),l===e&&(l=null),c=$(),o.substr(r,2)===T?(u=T,r+=2):(u=e,a===0&&g(mt)),u!==e?(d=$(),y=qe(),x=t,t=Dt(l,y)):(r=t,t=e),a--,t===e&&(s=e,a===0&&g(dt)),t}function De(){let t,s;return a++,t=is(),a--,t===e&&(s=e,a===0&&g(re)),t}function is(){let t,s,n,l,c,u,d,y;for(a++,t=r,s=r,n=[],l=ze();l!==e;)n.push(l),l=r,c=r,u=$(),o.substr(r,2)===D?(d=D,r+=2):(d=e,a===0&&g($t)),d!==e?(y=$(),u=[u,d,y],c=u):(r=c,c=e),c!==e?(c=ze(),c===e?(r=l,l=e):l=c):l=c;return n.length<1?(r=s,s=e):s=n,s!==e&&(x=t,s=zt(s)),t=s,a--,t===e&&(s=e,a===0&&g(re)),t}function ze(){let t,s,n,l,c,u,d,y;for(a++,t=r,s=r,n=[],l=de();l!==e;)n.push(l),l=r,c=r,u=$(),o.substr(r,3)===z?(d=z,r+=3):(d=e,a===0&&g(bt)),d!==e?(y=$(),u=[u,d,y],c=u):(r=c,c=e),c!==e?(c=de(),c===e?(r=l,l=e):l=c):l=c;return n.length<1?(r=s,s=e):s=n,s!==e&&(x=t,s=Lt(s)),t=s,a--,t===e&&(s=e,a===0&&g(re)),t}function de(){let t,s,n,l,c,u;return a++,t=r,o.substr(r,3)===k?(s=k,r+=3):(s=e,a===0&&g(pe)),s!==e?(n=$(),o.substr(r,3)===k?(l=k,r+=3):(l=e,a===0&&g(pe)),l!==e?(c=$(),u=de(),u!==e?t=u:(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,o.substr(r,3)===k?(s=k,r+=3):(s=e,a===0&&g(pe)),s!==e?(n=$(),l=Le(),l!==e?(x=t,t=qt(l)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,s=Le(),s!==e?t=s:(r=t,t=e))),a--,t===e&&(s=e,a===0&&g(re)),t}function Le(){let t,s;return t=r,s=$e(),s!==e&&(x=t,s=Mt(s)),t=s,t}function qe(){let t,s,n,l,c,u,d,y,H;for(t=r,s=[],n=me(),n===e&&(n=be());n!==e;){if(s.push(n),n=r,l=r,c=$(),o.charCodeAt(r)===44?(u=b,r++):(u=e,a===0&&g(wt)),u!==e){for(d=$(),y=[],H=G();H!==e;)y.push(H),H=G();H=$(),c=[c,u,d,y,H],l=c}else r=l,l=e;l!==e?(l=me(),l===e&&(l=be()),l===e?(r=n,n=e):n=l):n=l}return t=s,t}function me(){let t,s,n,l;return a++,t=r,s=Me(),s!==e?(o.charCodeAt(r)===36?(n=m,r++):(n=e,a===0&&g(xt)),n!==e?(l=$e(),l!==e?(x=t,t=Ut(s,l)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),a--,t===e&&(s=e,a===0&&g(Ie)),t}function Me(){let t,s,n;if(a++,t=r,s=[],n=o.charAt(r),Ae.test(n)?r++:(n=e,a===0&&g(Fe)),n!==e)for(;n!==e;)s.push(n),n=o.charAt(r),Ae.test(n)?r++:(n=e,a===0&&g(Fe));else s=e;return s!==e?t=o.substring(t,r):t=s,a--,t===e&&(s=e,a===0&&g(Ie)),t}function $e(){let t,s,n,l,c;if(a++,t=r,s=r,n=o.charAt(r),ct.test(n)?r++:(n=e,a===0&&g(Rt)),n!==e){for(l=[],c=o.charAt(r),Ce.test(c)?r++:(c=e,a===0&&g(Ne));c!==e;)l.push(c),c=o.charAt(r),Ce.test(c)?r++:(c=e,a===0&&g(Ne));n=[n,l],s=n}else r=s,s=e;return s!==e?t=o.substring(t,r):t=s,a--,t===e&&(s=e,a===0&&g(yt)),t}function be(){let t,s,n,l;return a++,t=r,s=os(),s!==e?(n=$(),l=Ge(),l!==e?(x=t,t=Gt(s,l)):(r=t,t=e)):(r=t,t=e),a--,t===e&&(s=e,a===0&&g(At)),t}function os(){let t,s,n,l,c,u;return a++,t=r,o.charCodeAt(r)===91?(s=F,r++):(s=e,a===0&&g(Et)),s!==e?(n=$(),l=Ue(),l!==e?(c=$(),o.charCodeAt(r)===93?(u=L,r++):(u=e,a===0&&g(vt)),u!==e?t=l:(r=t,t=e)):(r=t,t=e)):(r=t,t=e),a--,t===e&&(s=e,a===0&&g(Ct)),t}function Ue(){let t,s,n;if(a++,t=r,s=[],n=o.charAt(r),Ee.test(n)?r++:(n=e,a===0&&g(Oe)),n!==e)for(;n!==e;)s.push(n),n=o.charAt(r),Ee.test(n)?r++:(n=e,a===0&&g(Oe));else s=e;return s!==e?t=o.substring(t,r):t=s,a--,t===e&&(s=e,a===0&&g(Vt)),t}function Ge(){let t,s,n,l,c;for(a++,t=r,s=r,n=[],l=He();l!==e;)n.push(l),l=r,c=$(),c=He(),c===e?(r=l,l=e):l=c;if(s=o.substring(s,r),n=$(),l=Ze(),l!==e?(x=r,c=Ht(s,l),c?c=void 0:c=e,c!==e?(x=t,t=Zt(s,l)):(r=t,t=e)):(r=t,t=e),t===e){for(t=r,s=r,n=[],l=we();l!==e;)n.push(l),l=r,c=$(),c=we(),c===e?(r=l,l=e):l=c;s=o.substring(s,r),x=t,s=Bt(s),t=s}return a--,t===e&&(s=e,a===0&&g(St)),t}function He(){let t,s,n,l,c,u;return a++,t=r,s=r,a++,n=r,l=Ze(),l!==e?(c=$(),u=Ke(),u===e&&(u=o.charAt(r),ft.test(u)?r++:(u=e,a===0&&g(Ft))),u!==e?(l=[l,c,u],n=l):(r=n,n=e)):(r=n,n=e),a--,n===e?s=void 0:(r=s,s=e),s!==e?(n=we(),n!==e?t=n:(r=t,t=e)):(r=t,t=e),a--,t===e&&(s=e,a===0&&g(It)),t}function we(){let t,s,n;if(t=r,s=[],n=o.charAt(r),ve.test(n)?r++:(n=e,a===0&&g(Te)),n!==e)for(;n!==e;)s.push(n),n=o.charAt(r),ve.test(n)?r++:(n=e,a===0&&g(Te));else s=e;return s!==e?t=o.substring(t,r):t=s,t}function Ze(){let t,s,n;return a++,t=r,s=Be(),s!==e?(o.substr(r,2)===Re?(n=Re,r+=2):(n=e,a===0&&g(Ot)),n!==e?(x=t,t=Kt(s)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,s=Be(),s!==e?(o.charCodeAt(r)===103?(n=lt,r++):(n=e,a===0&&g(Tt)),n===e&&(n=null),t=s):(r=t,t=e)),a--,t===e&&(s=e,a===0&&g(Nt)),t}function Be(){let t,s,n,l,c,u,d;if(a++,t=r,s=[],n=o.charAt(r),te.test(n)?r++:(n=e,a===0&&g(ne)),n!==e)for(;n!==e;)s.push(n),n=o.charAt(r),te.test(n)?r++:(n=e,a===0&&g(ne));else s=e;if(s!==e){if(n=r,o.charCodeAt(r)===46?(l=at,r++):(l=e,a===0&&g(Wt)),l!==e){if(c=r,u=[],d=o.charAt(r),te.test(d)?r++:(d=e,a===0&&g(ne)),d!==e)for(;d!==e;)u.push(d),d=o.charAt(r),te.test(d)?r++:(d=e,a===0&&g(ne));else u=e;u!==e?c=o.substring(c,r):c=u,c!==e?(l=[l,c],n=l):(r=n,n=e)}else r=n,n=e;n===e&&(n=null),x=t,t=Xt()}else r=t,t=e;return a--,t===e&&(s=e,a===0&&g(kt)),t}function $(){let t,s;for(a++,t=[],s=o.charAt(r),Ve.test(s)?r++:(s=e,a===0&&g(ke));s!==e;)t.push(s),s=o.charAt(r),Ve.test(s)?r++:(s=e,a===0&&g(ke));return a--,t}function Ke(){let t,s,n;return t=r,s=r,a++,o.length>r?(n=o.charAt(r),r++):(n=e,a===0&&g(Pt)),a--,n===e?s=void 0:(r=s,s=e),s!==e&&(x=t,s=Yt()),t=s,t}let Xe=!1,xe=new Set,oe=new Set,le=[];K=h();let ye=K!==e&&r===o.length;function Ye(){throw K!==e&&r<o.length&&g(ss()),_e(ie,v<o.length?es(v):null,v<o.length?X(v,v+1):X(v,v))}if(i.peg$library)return{peg$result:K,peg$currPos:r,peg$FAILED:e,peg$maxFailExpected:ie,peg$maxFailPos:v,peg$success:ye,peg$throw:ye?void 0:Ye};if(ye)return K;Ye()}var ce=class{constructor(i){this.description=i}},fe=()=>{};var us={isTrackWeight:()=>!1},gs=new ce("PARSER_CONFIG_PROVIDER"),j=class{config=void 0??us;isTrackWeight(){return this.config.isTrackWeight()}makeOptions(i,e={}){return{startRule:i,trackWeight:e.forceWeightTracking??this.isTrackWeight()}}parseCondition(i){return E(i,this.makeOptions("Condition"))}parseQuestion(i){return E(i,this.makeOptions("Question"))}parseItem(i){return E(i,this.makeOptions("Item"))}parseEffects(i){return E(i,this.makeOptions("Effects"))}parseRule(i){return E(i,this.makeOptions("Rule"))}parseRules(i){try{return E(i,this.makeOptions("Rules"))}catch(e){let f=[];if(f.push("Error parsing rules"),e instanceof Q){let p=e.location.start.line.toString(),h=e.location.start.column.toString();f.push(" at line ",p," column ",h),f.push(":",`
`,e.message)}else e instanceof Error&&f.push(e.message);throw new Error(f.join(""))}}validateVariableName(i){E(i,this.makeOptions("VariableName"))}validateQuestionString(i){E(i,this.makeOptions("QuestionString"))}validateItemNameAndWeight(i){E(i,this.makeOptions("ItemNameAndWeight"))}validateCategoryName(i){E(i,this.makeOptions("CategoryName"))}forceParseWeight(i){return E(i,this.makeOptions("ItemNameAndWeight",{forceWeightTracking:!0})).weight??0}};j=ae([fe({providedIn:"root"})],j);var Y=class{parser=(j,void 0);extractVariablesFromCondition(i){if(i instanceof N||i instanceof Z)return new Set;if(i instanceof C)return new Set([i.variable]);if(i instanceof V)return this.extractVariablesFromCondition(i.not);if(i instanceof S||i instanceof I)return this.extractVariablesFromCondition(i.left).union(this.extractVariablesFromCondition(i.right));throw new Error("unknown condition type")}extractVariables(i,e=!1){return i.reduce((f,p)=>{let h=f.union(new Set(p.questions.map(w=>w.variable)));return e?h:h.union(this.extractVariablesFromCondition(p.condition))},new Set)}extractCategories(i){let e=new Set;for(let f of i)for(let p of f.items)e.add(p.category);return Array.from(e)}renameVariable(i,e,f){if(f instanceof Array)return f.map(h=>this.renameVariable(i,e,h));if(f instanceof P)return f.variable===i?new P(f.question,e):f;if(f instanceof _)return new _(this.renameVariable(i,e,f.condition),f.questions.map(h=>this.renameVariable(i,e,h)),f.items);if(f instanceof C)return f.variable===i?new C(e):f;if(f instanceof V)return new V(this.renameVariable(i,e,f.not));if(f instanceof S)return new S(this.renameVariable(i,e,f.left),this.renameVariable(i,e,f.right));if(f instanceof I)return new I(this.renameVariable(i,e,f.left),this.renameVariable(i,e,f.right));let p=f;throw new Error("Unknown item type: "+p)}filterActive(i){let e=i.rules.filter(h=>h.condition.evaluate(i.model)),f=this.extractVariables(e,!0),p=Array.from(f).reduce((h,w)=>({...h,[w]:i.model[w]}),{[N.string]:!0});return e.length===i.rules.length?{model:p,rules:e}:this.filterActive({model:p,rules:e})}contains(i,e){let f=e.toLowerCase();if(i instanceof _)return this.contains(i.condition,e)||i.questions.some(h=>this.contains(h,e))||i.items.some(h=>this.contains(h,e));if(i instanceof P)return i.question.toLowerCase().includes(f)||i.variable.toLowerCase().includes(f);if(i instanceof q)return i.category.toLowerCase().includes(f)||i.name.toLowerCase().includes(f);if(i instanceof C)return i.variable.toLowerCase().includes(f);if(i instanceof V)return this.contains(i.not,e);if(i instanceof S)return this.contains(i.left,e)||this.contains(i.right,e);if(i instanceof I)return this.contains(i.left,e)||this.contains(i.right,e);let p=i;throw new Error("Unknown item type: "+p)}countItemsAndWeights(i){return i.reduce((e,f)=>f.items.reduce((p,h)=>{let w;return this.parser.isTrackWeight()?w=h.weight?1:0:w=this.parser.forceParseWeight(h.name)?1:0,{items:p.items+1,weights:p.weights+w}},e),{items:0,weights:0})}};Y=ae([fe({providedIn:"root"})],Y);function st(o){let i=o.title?.trim();return(i?`# ${i}

`:"")+o.map(f=>hs(f)).map(f=>f+";").join(`

`)+`
`}function ps(o,i,e=-1){if(!o)return"0g";let f=(e<0?o/1e3:(o/1e3).toFixed(e)).toString()+"kg",p=o.toString()+"g";return i?i==="kg"?f:p:f.length<=p.length?f:p}function hs(o){let i=[];if(!(o.condition instanceof N)){let f=B(o.condition);f&&i.push(f," ")}i.push(":-");let e=o.questions.map(f=>ds(f)).concat(o.items.map(f=>ms(f)));if(e.length===1&&i.length===1)i.push(" ",e[0]);else for(let f=0;f<e.length;f++){let p=e[f];f>0&&i.push(","),i.push(`
`,"   ",p)}return i.join("")}function ds(o){return o.question+" $"+o.variable}function ms(o){let i=`[${o.category}] ${o.name}`.trim();return o.weight&&(i+=" "+ps(o.weight)),i}function B(o){if(o instanceof C)return o.variable;if(o instanceof V)return"NOT "+B(o.not);if(o instanceof S)return B(o.left)+" AND "+B(o.right);if(o instanceof I)return B(o.left)+" OR "+B(o.right);throw new Error("Unknown condition type")}var ge=require("fs"),rt=require("path"),M=process.argv.slice(2);function nt(){console.log(`
Usage: node ${process.argv[0]} ${process.argv[1]} [options] file

Options:
  --validate            Validate the Rules file (default action)
  --error-on-warnings   Treat warnings as errors (default false)
  --format              Format the Rules file (in-place)
                        (implies --validate)

  --help, -h            Show this help message
  --version, -v         Show version information
`)}(M.includes("--help")||M.includes("-h"))&&(nt(),process.exit(0));(M.includes("--version")||M.includes("-v"))&&(console.log(`Version: 1.4.0
Build: af5c727313a76a9c46fb8955f39d454c841bcda1`),process.exit(0));var it=M.find(o=>!o.startsWith("-"));it||(console.error("Error: No input file specified."),nt(),process.exit(1));var J=(0,rt.resolve)(process.cwd(),it),ot;try{ot=(0,ge.readFileSync)(J,"utf-8")}catch(o){console.error(`Error: Unable to read file '${J}': ${o.message}`),process.exit(1)}var $s=new j,bs=M.includes("--format"),ws=M.includes("--error-on-warnings"),ue;try{ue=$s.parseRules(ot)}catch(o){console.error(o.message),process.exit(1)}if(ue.warnings?.length){for(let o of ue.warnings)console.warn(`Variable "${o.variable}" is ${o.type}!`);ws&&(console.error("Found warnings!"),process.exit(1))}if(bs){let o=st(ue);(0,ge.writeFileSync)(J,o,{encoding:"utf-8"}),console.log(`File '${J}' formatted successfully.`)}else console.log(`File '${J}' is valid.`);
